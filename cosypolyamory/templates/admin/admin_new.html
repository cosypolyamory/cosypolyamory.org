{% extends "layout/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>Admin Dashboard</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mt-3">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- User Management Tabs -->
        <div class="card mt-4">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab" aria-controls="pending" aria-selected="true">
                            Pending <span class="badge bg-warning ms-1 tab-badge" id="pending-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members" type="button" role="tab" aria-controls="members" aria-selected="false">
                            Members <span class="badge bg-success ms-1 tab-badge" id="members-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="organizers-tab" data-bs-toggle="tab" data-bs-target="#organizers" type="button" role="tab" aria-controls="organizers" aria-selected="false">
                            Organizers <span class="badge bg-primary ms-1 tab-badge" id="organizers-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab" aria-controls="rejected" aria-selected="false">
                            Rejected <span class="badge bg-secondary ms-1 tab-badge" id="rejected-count">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab" aria-controls="admins" aria-selected="false">
                            Admins <span class="badge bg-danger ms-1 tab-badge" id="admins-count">0</span>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="adminTabsContent">
                    <!-- Pending Users Tab -->
                    <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Pending Applications</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Showing <span id="pending-showing">0</span> of <span id="pending-total">0</span></span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="pending-prev" onclick="changePage('pending', -1)">&laquo;</button>
                                    <span class="btn btn-outline-secondary" id="pending-page">1</span>
                                    <button class="btn btn-outline-secondary" id="pending-next" onclick="changePage('pending', 1)">&raquo;</button>
                                </div>
                            </div>
                        </div>
                        <div id="pending-users" class="user-list"></div>
                    </div>

                    <!-- Members Tab -->
                    <div class="tab-pane fade" id="members" role="tabpanel" aria-labelledby="members-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Approved Members</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Showing <span id="members-showing">0</span> of <span id="members-total">0</span></span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="members-prev" onclick="changePage('members', -1)">&laquo;</button>
                                    <span class="btn btn-outline-secondary" id="members-page">1</span>
                                    <button class="btn btn-outline-secondary" id="members-next" onclick="changePage('members', 1)">&raquo;</button>
                                </div>
                            </div>
                        </div>
                        <div id="members-users" class="user-list"></div>
                    </div>

                    <!-- Organizers Tab -->
                    <div class="tab-pane fade" id="organizers" role="tabpanel" aria-labelledby="organizers-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Event Organizers</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Showing <span id="organizers-showing">0</span> of <span id="organizers-total">0</span></span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="organizers-prev" onclick="changePage('organizers', -1)">&laquo;</button>
                                    <span class="btn btn-outline-secondary" id="organizers-page">1</span>
                                    <button class="btn btn-outline-secondary" id="organizers-next" onclick="changePage('organizers', 1)">&raquo;</button>
                                </div>
                            </div>
                        </div>
                        <div id="organizers-users" class="user-list"></div>
                    </div>

                    <!-- Rejected Tab -->
                    <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Rejected Applications</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Showing <span id="rejected-showing">0</span> of <span id="rejected-total">0</span></span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="rejected-prev" onclick="changePage('rejected', -1)">&laquo;</button>
                                    <span class="btn btn-outline-secondary" id="rejected-page">1</span>
                                    <button class="btn btn-outline-secondary" id="rejected-next" onclick="changePage('rejected', 1)">&raquo;</button>
                                </div>
                            </div>
                        </div>
                        <div id="rejected-users" class="user-list"></div>
                    </div>

                    <!-- Admins Tab -->
                    <div class="tab-pane fade" id="admins" role="tabpanel" aria-labelledby="admins-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">System Administrators</h6>
                            <div class="d-flex align-items-center">
                                <span class="text-muted me-3">Showing <span id="admins-showing">0</span> of <span id="admins-total">0</span></span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-secondary" id="admins-prev" onclick="changePage('admins', -1)">&laquo;</button>
                                    <span class="btn btn-outline-secondary" id="admins-page">1</span>
                                    <button class="btn btn-outline-secondary" id="admins-next" onclick="changePage('admins', 1)">&raquo;</button>
                                </div>
                            </div>
                        </div>
                        <div id="admins-users" class="user-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Detail Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="deleteModalBody">
                Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .user-card {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background-color: #fff;
    }
    .user-card:hover {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .user-list {
        max-height: 600px;
        overflow-y: auto;
    }
    .role-badge {
        font-size: 0.75rem;
    }
    .tab-badge {
        font-size: 0.7rem;
    }
    /* Ensure dropdown menus are always on top and never clipped */
    .dropdown-menu {
        z-index: 1060 !important;
        min-width: 180px;
    }
    .user-card {
        position: relative;
        overflow: visible;
    }
    .user-list {
        overflow: visible;
    }
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
let currentPages = {
    pending: 1,
    approved: 1,
    organizer: 1,
    rejected: 1,
    admin: 1
};

const pageSize = 50;

document.addEventListener('DOMContentLoaded', function() {
    // Load pending users by default
    loadUsers('pending');
    
    // Add tab change listeners
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target').substring(1);
            const role = targetId === 'members' ? 'approved' : 
                        targetId === 'organizers' ? 'organizer' :
                        targetId === 'admins' ? 'admin' : targetId;
            loadUsers(role);
        });
    });
});

function loadUsers(role, page = 1) {
    currentPages[role] = page;
    
    fetch(`/api/admin/users/${role}?page=${page}&per_page=${pageSize}`)
        .then(response => response.json())
        .then(data => {
            const tabName = role === 'approved' ? 'members' :
                           role === 'organizer' ? 'organizers' :
                           role === 'admin' ? 'admins' : role;
            updateUserList(tabName, data.users);
            updatePagination(tabName, data.pagination);
            updateTabCount(tabName, data.pagination.total);
        })
        .catch(error => {
            console.error('Error loading users:', error);
            showToast('Error loading users', 'error');
        });
}

function updateUserList(tabName, users) {
    const container = document.getElementById(`${tabName}-users`);
    
    if (users.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-5">No users found</div>';
        return;
    }
    
    container.innerHTML = users.map(user => createUserCard(user)).join('');
}

function createUserCard(user) {
    const roleColors = {
        admin: 'danger',
        organizer: 'primary', 
        approved: 'success',
        pending: 'warning',
        rejected: 'secondary'
    };
    
    const roleName = {
        admin: 'Admin',
        organizer: 'Organizer',
        approved: 'Member',
        pending: 'Pending',
        rejected: 'Rejected'
    };
    
    return `
        <div class="user-card">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    ${user.avatar_url ? 
                        `<img src="${user.avatar_url}" alt="Avatar" class="rounded-circle" style="width: 50px; height: 50px;">` :
                        `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-white"></i>
                        </div>`
                    }
                </div>
                <div class="flex-grow-1">
                    <h6 class="mb-1">${user.name}</h6>
                    <p class="text-muted mb-1" title="${user.email}">
                        <i class="fas fa-envelope me-1"></i>${user.email}
                    </p>
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>Joined ${new Date(user.created_at).toLocaleDateString()}
                        <i class="fab fa-${user.provider} ms-2 me-1"></i>${user.provider}
                    </small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-${roleColors[user.role]} role-badge me-3">${roleName[user.role]}</span>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewUser('${user.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" title="Change Role">
                                <i class="fas fa-user-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><button class="dropdown-item" onclick="changeRole('${user.id}', 'admin')">
                                    <i class="fas fa-crown text-danger me-2"></i>Make Admin
                                </button></li>
                                <li><button class="dropdown-item" onclick="changeRole('${user.id}', 'organizer')">
                                    <i class="fas fa-calendar text-primary me-2"></i>Make Organizer
                                </button></li>
                                <li><button class="dropdown-item" onclick="changeRole('${user.id}', 'approved')">
                                    <i class="fas fa-check text-success me-2"></i>Approve Member
                                </button></li>
                                <li><button class="dropdown-item" onclick="changeRole('${user.id}', 'pending')">
                                    <i class="fas fa-clock text-warning me-2"></i>Mark Pending
                                </button></li>
                                <li><button class="dropdown-item" onclick="changeRole('${user.id}', 'rejected')">
                                    <i class="fas fa-times text-danger me-2"></i>Reject
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item text-danger" onclick="deleteUser('${user.id}', '${user.name}')">
                                    <i class="fas fa-trash me-2"></i>Delete User
                                </button></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updatePagination(tabName, pagination) {
    const showing = Math.min(pagination.per_page, pagination.total - (pagination.page - 1) * pagination.per_page);
    document.getElementById(`${tabName}-showing`).textContent = showing;
    document.getElementById(`${tabName}-total`).textContent = pagination.total;
    document.getElementById(`${tabName}-page`).textContent = pagination.page;
    
    const prevBtn = document.getElementById(`${tabName}-prev`);
    const nextBtn = document.getElementById(`${tabName}-next`);
    if (prevBtn) prevBtn.disabled = pagination.page <= 1;
    if (nextBtn) nextBtn.disabled = pagination.page >= pagination.pages;
}

function updateTabCount(tabName, count) {
    const countElement = document.getElementById(`${tabName}-count`);
    if (countElement) countElement.textContent = count;
}

function changePage(tabName, direction) {
    const role = tabName === 'members' ? 'approved' :
                 tabName === 'organizers' ? 'organizer' :
                 tabName === 'admins' ? 'admin' : tabName;
    const newPage = currentPages[role] + direction;
    if (newPage >= 1) {
        loadUsers(role, newPage);
    }
}

function changeRole(userId, newRole) {
    fetch('/api/admin/change-role', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            role: newRole
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Role changed to ${newRole}`, 'success');
            // Reload current tab
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target').substring(1);
            const activeRole = activeTab === 'members' ? 'approved' :
                              activeTab === 'organizers' ? 'organizer' :
                              activeTab === 'admins' ? 'admin' : activeTab;
            loadUsers(activeRole, currentPages[activeRole]);
            // Also reload other tabs to update counts
            ['pending', 'approved', 'organizer', 'rejected', 'admin'].forEach(role => {
                if (role !== activeRole) {
                    fetch(`/api/admin/users/${role}?page=1&per_page=1`)
                        .then(r => r.json())
                        .then(d => {
                            const tabName = role === 'approved' ? 'members' :
                                           role === 'organizer' ? 'organizers' :
                                           role === 'admin' ? 'admins' : role;
                            updateTabCount(tabName, d.pagination.total);
                        });
                }
            });
        } else {
            showToast(data.error || 'Failed to change role', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error changing role', 'error');
    });
}

function viewUser(userId) {
    fetch(`/api/admin/user/${userId}`)
        .then(response => response.json())
        .then(data => {
            const modalBody = document.getElementById('userModalBody');
            modalBody.innerHTML = `
                <div class="text-center mb-3">
                    ${data.avatar_url ? 
                        `<img src="${data.avatar_url}" alt="Avatar" class="rounded-circle" style="width: 100px; height: 100px;">` :
                        `<div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mx-auto" style="width: 100px; height: 100px;">
                            <i class="fas fa-user fa-2x text-white"></i>
                        </div>`
                    }
                </div>
                <dl class="row">
                    <dt class="col-sm-4">Name:</dt>
                    <dd class="col-sm-8">${data.name}</dd>
                    <dt class="col-sm-4">Email:</dt>
                    <dd class="col-sm-8">${data.email}</dd>
                    <dt class="col-sm-4">Provider:</dt>
                    <dd class="col-sm-8"><i class="fab fa-${data.provider} me-1"></i>${data.provider}</dd>
                    <dt class="col-sm-4">User ID:</dt>
                    <dd class="col-sm-8"><code>${data.id}</code></dd>
                    <dt class="col-sm-4">Role:</dt>
                    <dd class="col-sm-8"><span class="badge bg-primary">${data.role}</span></dd>
                    <dt class="col-sm-4">Joined:</dt>
                    <dd class="col-sm-8">${new Date(data.created_at).toLocaleDateString()}</dd>
                    <dt class="col-sm-4">Last Login:</dt>
                    <dd class="col-sm-8">${new Date(data.last_login).toLocaleDateString()}</dd>
                </dl>
            `;
            const modal = new bootstrap.Modal(document.getElementById('userModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading user details', 'error');
        });
}

function deleteUser(userId, userName) {
    document.getElementById('deleteModalBody').innerHTML = 
        `Are you sure you want to delete user <strong>${userName}</strong>? This action cannot be undone.`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
    
    document.getElementById('confirmDeleteBtn').onclick = function() {
        fetch(`/api/admin/delete-user`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ user_id: userId })
        })
        .then(response => response.json())
        .then(data => {
            modal.hide();
            if (data.success) {
                showToast('User deleted successfully', 'success');
                const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target').substring(1);
                const activeRole = activeTab === 'members' ? 'approved' :
                                  activeTab === 'organizers' ? 'organizer' :
                                  activeTab === 'admins' ? 'admin' : activeTab;
                loadUsers(activeRole, currentPages[activeRole]);
            } else {
                showToast(data.error || 'Failed to delete user', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modal.hide();
            showToast('Error deleting user', 'error');
        });
    };
}

function showToast(message, type) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}
</script>
{% endblock %}
