{% extends "layout/base.html" %}

{% block title %}Edit Attendance - {{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('events.event_detail', event_id=event.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left me-2"></i>Back to Event
                            </a>
                            <a href="{{ url_for('events.events_list') }}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-list me-2"></i>All Events
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h1>Edit Attendance</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-3">
                <div class="col-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                            {{ message|safe }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- Event Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">{{ event.title }}</h4>
                    <p class="text-muted mb-2">
                        <i class="fas fa-calendar me-2"></i>
                        {{ event.exact_time.strftime('%A, %B %d, %Y at %I:%M %p') }}
                    </p>
                    {% if event.max_attendees %}
                    <p class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        Capacity: {{ rsvp_count }}/{{ event.max_attendees }} attendees
                        {% if rsvp_count >= event.max_attendees %}
                            <span class="badge bg-warning text-dark ms-2">Full</span>
                        {% endif %}
                        {% if waitlist_count > 0 %}
                            <span class="badge bg-secondary ms-2">{{ waitlist_count }} waitlisted</span>
                        {% endif %}
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Management -->
    <div class="row">
        <div class="col-12">
            <!-- Attending -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-check me-2"></i>
                        Attending ({{ rsvp_count }})
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if rsvps_attending %}
                        <div class="list-group list-group-flush">
                            {% for rsvp in rsvps_attending %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold">{{ rsvp.user.name }}</span>
                                            {% if rsvp.user.id == organizer_id %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-crown me-1"></i>Host
                                                </span>
                                            {% elif rsvp.user.id == co_host_id %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user-friends me-1"></i>Co-Host
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            RSVP'd {{ rsvp.created_at.strftime('%m/%d/%Y at %I:%M %p') }}
                                        </small>
                                    </div>
                                    {% if rsvp.user.id != organizer_id and rsvp.user.id != co_host_id %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            Manage
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'waitlist', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-hourglass-half me-2 text-warning"></i>Move to Waitlist
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'no', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-times me-2 text-danger"></i>Move to Not Attending
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="removeRSVP({{ event.id }}, '{{ rsvp.user.id }}', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-trash me-2"></i>Remove RSVP
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-user-plus fa-2x mb-2"></i>
                            <p class="mb-0">No attendees yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Waitlist -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-hourglass-half me-2"></i>
                        Waitlist ({{ waitlist_count }})
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if rsvps_waitlist %}
                        <div class="list-group list-group-flush">
                            {% for rsvp in rsvps_waitlist %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold">{{ rsvp.user.name }}</span>
                                            {% if rsvp.user.id == organizer_id %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-crown me-1"></i>Host
                                                </span>
                                            {% elif rsvp.user.id == co_host_id %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user-friends me-1"></i>Co-Host
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            Waitlisted {{ rsvp.created_at.strftime('%m/%d/%Y at %I:%M %p') }}
                                        </small>
                                    </div>
                                    {% if rsvp.user.id != organizer_id and rsvp.user.id != co_host_id %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            Manage
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if not event.max_attendees or rsvp_count < event.max_attendees %}
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'yes', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-check me-2 text-success"></i>Move to Attending
                                                </button>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'no', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-times me-2 text-danger"></i>Move to Not Attending
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="removeRSVP({{ event.id }}, '{{ rsvp.user.id }}', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-trash me-2"></i>Remove RSVP
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% else %}
                                    <div class="text-muted small">
                                        <i class="fas fa-lock me-1"></i>Protected
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-hourglass-half fa-2x mb-2"></i>
                            <p class="mb-0">No one on waitlist</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Not Attending -->
            <div class="card mb-4">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-times me-2"></i>
                        Not Attending ({{ not_attending_count }})
                    </h6>
                </div>
                <div class="card-body p-0">
                    {% if rsvps_not_attending %}
                        <div class="list-group list-group-flush">
                            {% for rsvp in rsvps_not_attending %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="fw-bold">{{ rsvp.user.name }}</span>
                                            {% if rsvp.user.id == organizer_id %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-crown me-1"></i>Host
                                                </span>
                                            {% elif rsvp.user.id == co_host_id %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user-friends me-1"></i>Co-Host
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">
                                            RSVP'd {{ rsvp.created_at.strftime('%m/%d/%Y at %I:%M %p') }}
                                        </small>
                                    </div>
                                    {% if rsvp.user.id != organizer_id and rsvp.user.id != co_host_id %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            Manage
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% if not event.max_attendees or rsvp_count < event.max_attendees %}
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'yes', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-check me-2 text-success"></i>Move to Attending
                                                </button>
                                            </li>
                                            {% endif %}
                                            <li>
                                                <button class="dropdown-item" onclick="moveRSVP({{ event.id }}, '{{ rsvp.user.id }}', 'waitlist', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-hourglass-half me-2 text-warning"></i>Move to Waitlist
                                                </button>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <button class="dropdown-item text-danger" onclick="removeRSVP({{ event.id }}, '{{ rsvp.user.id }}', '{{ rsvp.user.name }}')">
                                                    <i class="fas fa-trash me-2"></i>Remove RSVP
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    {% else %}
                                    <div class="text-muted small">
                                        <i class="fas fa-lock me-1"></i>Protected
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-user-times fa-2x mb-2"></i>
                            <p class="mb-0">No one marked as not attending</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmMoveModal" tabindex="-1" aria-labelledby="confirmMoveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmMoveModalLabel">Confirm RSVP Move</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMoveText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMoveBtn">Move</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove RSVP Modal -->
<div class="modal fade" id="confirmRemoveModal" tabindex="-1" aria-labelledby="confirmRemoveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmRemoveModalLabel">Remove RSVP</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmRemoveText"></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables for modal confirmation
let pendingMoveAction = null;
let pendingRemoveAction = null;

// Updated moveRSVP function with modal confirmation
function moveRSVP(eventId, userId, newStatus, userName) {
    // Set up the confirmation modal
    const statusText = newStatus === 'yes' ? 'Attending' : 
                      newStatus === 'waitlist' ? 'Waitlist' :
                      newStatus === 'no' ? 'Not Attending' : newStatus;
    
    document.getElementById('confirmMoveText').textContent = `Move ${userName} to ${statusText}?`;
    
    // Store the action to execute if confirmed
    pendingMoveAction = () => {
        executeMoveRSVP(eventId, userId, newStatus, userName);
    };
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('confirmMoveModal'));
    modal.show();
}

function executeMoveRSVP(eventId, userId, newStatus, userName) {
    fetch(`/events/${eventId}/admin/rsvp/${userId}/move`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json'
        },
        body: `status=${encodeURIComponent(newStatus)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message briefly before reload
            showToast('Success', data.message || `${userName} moved successfully`, 'success');
            // Reload the page to show updated attendance
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Error', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while updating the RSVP.', 'error');
    });
}

function removeRSVP(eventId, userId, userName) {
    // Set up the confirmation modal
    document.getElementById('confirmRemoveText').textContent = `Remove ${userName}'s RSVP entirely?`;
    
    // Store the action to execute if confirmed
    pendingRemoveAction = () => {
        executeRemoveRSVP(eventId, userId, userName);
    };
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('confirmRemoveModal'));
    modal.show();
}

function executeRemoveRSVP(eventId, userId, userName) {
    fetch(`/events/${eventId}/admin/rsvp/${userId}/remove`, {
        method: 'POST',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message briefly before reload
            showToast('Success', data.message || `${userName}'s RSVP removed successfully`, 'success');
            // Reload the page to show updated attendance
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Error', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'An error occurred while removing the RSVP.', 'error');
    });
}

// Toast notification function
function showToast(title, message, type) {
    const toastClass = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
    const toastHtml = `
        <div class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '1055';
        document.body.appendChild(toastContainer);
    }
    
    // Add the toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove from DOM after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Event listeners for modal confirmation buttons
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmMoveBtn').addEventListener('click', function() {
        if (pendingMoveAction) {
            pendingMoveAction();
            pendingMoveAction = null;
        }
        bootstrap.Modal.getInstance(document.getElementById('confirmMoveModal')).hide();
    });
    
    document.getElementById('confirmRemoveBtn').addEventListener('click', function() {
        if (pendingRemoveAction) {
            pendingRemoveAction();
            pendingRemoveAction = null;
        }
        bootstrap.Modal.getInstance(document.getElementById('confirmRemoveModal')).hide();
    });
});
</script>
{% endblock %}
