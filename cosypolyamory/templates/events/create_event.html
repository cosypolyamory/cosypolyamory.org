{% extends "layout/base.html" %}

{% block title %}{% if is_edit %}Edit Event{% else %}Create Event{% endif %}{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if is_edit %}Edit Event{% else %}Create New Event{% endif %}</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <div class="card mt-4">
        <div class="card-body">
                <form method="POST" action="{% if is_edit %}{{ url_for('events.edit_event_post', event_id=event.id) }}{% else %}{{ url_for('events.create_event') }}{% endif %}"{% if event %} data-current-organizer="{{ event.organizer.id }}"{% if event.co_host %} data-current-cohost="{{ event.co_host.id }}"{% endif %}{% endif %}>
                    <!-- Basic Info -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary">Basic Information</h5>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="title" class="form-label">Event Title *</label>
                            <input type="text" class="form-control" id="title" name="title" required 
                                   placeholder="e.g., Community Game Night" value="{% if event %}{{ event.title }}{% endif %}">
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="description" class="form-label">Description *</label>
                            <textarea class="form-control" id="description" name="description" rows="16" required 
                                      placeholder="Describe your event...">{% if event %}{{ event.description }}{% endif %}</textarea>
                        </div>
                    </div>
                    
                    <!-- Date & Time -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary">Date & Time</h5>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="date" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="date" name="date" required
                                   value="{% if event %}{{ event.date.strftime('%Y-%m-%d') }}{% endif %}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="time" class="form-label">Time *</label>
                            <div class="row">
                                <!-- Modern Bootstrap time picker -->
                                <div class="input-group mb-2">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="hourDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-clock me-1"></i><span id="selectedHour">{% if event %}{{ '%02d'|format(event.exact_time.hour) }}{% else %}--{% endif %}</span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="hourDropdown">
                                        {% for hour in range(24) %}
                                        <li><a class="dropdown-item hour-option" href="#" data-value="{{ '%02d'|format(hour) }}">{{ '%02d'|format(hour) }}</a></li>
                                        {% endfor %}
                                    </ul>
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="minuteDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span id="selectedMinute">{% if event %}{{ '%02d'|format(event.exact_time.minute) }}{% else %}--{% endif %}</span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="minuteDropdown">
                                        {% for minute in [0, 15, 30, 45] %}
                                        <li><a class="dropdown-item minute-option" href="#" data-value="{{ '%02d'|format(minute) }}">{{ '%02d'|format(minute) }}</a></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <input type="hidden" id="modern_time_hour" name="time_hour" value="{% if event %}{{ '%02d'|format(event.exact_time.hour) }}{% endif %}">
                                <input type="hidden" id="modern_time_minute" name="time_minute" value="{% if event %}{{ '%02d'|format(event.exact_time.minute) }}{% endif %}">

                                <script>
                                document.addEventListener('DOMContentLoaded', function() {
                                    document.querySelectorAll('.hour-option').forEach(function(item) {
                                        item.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            document.getElementById('selectedHour').textContent = this.dataset.value;
                                            document.getElementById('modern_time_hour').value = this.dataset.value;
                                        });
                                    });
                                    document.querySelectorAll('.minute-option').forEach(function(item) {
                                        item.addEventListener('click', function(e) {
                                            e.preventDefault();
                                            document.getElementById('selectedMinute').textContent = this.dataset.value;
                                            document.getElementById('modern_time_minute').value = this.dataset.value;
                                        });
                                    });
                                });
                                </script
                                >

                                <!-- ...existing code... -->
                        </div>
                        
                    </div> <!-- close previous row -->
                    <div class="row mb-4">
                        <div class="col-12 mb-3">
                            <label for="time_period" class="form-label">Time Period (Public) *</label>
                            <input type="text" class="form-control" id="time_period" name="time_period" required 
                                   placeholder="e.g., Evening, Afternoon, Late Morning"
                                   value="{% if event %}{{ event.time_period }}{% endif %}">
                            <div class="form-text">This is what non-approved members will see instead of the exact time</div>
                        </div>
                    </div>
                    
                    <!-- Location -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary">Location</h5>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="establishment_name" class="form-label">Establishment Name *</label>
                            <input type="text" class="form-control" id="establishment_name" name="establishment_name" required 
                                   placeholder="e.g., Port Bay, Barna Brew, Venus"
                                   value="{% if event %}{{ event.establishment_name }}{% endif %}">
                            <div class="form-text">Name of the venue, restaurant, or meeting place</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="google_maps_link" class="form-label">Google Maps Link</label>
                            <input type="url" class="form-control" id="google_maps_link" name="google_maps_link"
                                   placeholder="https://maps.app.goo.gl/... or https://www.google.com/maps/@..."
                                   value="{% if event %}{{ event.google_maps_link }}{% endif %}">
                            <div class="form-text">Optional. Approved members will see an embedded map preview if provided.</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="barrio" class="form-label">Barrio (Public) *</label>
                            <input type="text" class="form-control" id="barrio" name="barrio" required 
                                   placeholder="e.g., The Born, GÃ²tic, Poble Sec"
                                   value="{% if event %}{{ event.barrio }}{% endif %}">
                            <div class="form-text">This is what non-approved members will see instead of the exact location</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="location_notes" class="form-label">Location Notes</label>
                            <textarea class="form-control" id="location_notes" name="location_notes" rows="2" 
                                      placeholder="e.g., Enter via side door, look for the group in the back room, second floor">{% if event %}{{ event.location_notes }}{% endif %}</textarea>
                            <div class="form-text">Additional directions or meeting details</div>
                        </div>
                    </div>
                    
                    <!-- Event Settings -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-primary">Event Settings</h5>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="organizer_id" class="form-label">Primary Organizer *</label>
                            <select class="form-select" id="organizer_id" name="organizer_id" required>
                                <option value="">Loading organizers...</option>
                            </select>
                            <div class="form-text">The primary organizer responsible for the event</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="co_host_id" class="form-label">Co-host (Optional)</label>
                            <select class="form-select" id="co_host_id" name="co_host_id">
                                <option value="">No co-host</option>
                            </select>
                            <div class="form-text">Optional second organizer to help with the event</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="max_attendees" class="form-label">Maximum Attendees</label>
                            <input type="number" class="form-control" id="max_attendees" name="max_attendees" 
                                   min="1" placeholder="Unlimited"
                                   value="{% if event and event.max_attendees %}{{ event.max_attendees }}{% endif %}">
                            <div class="form-text">Leave empty for unlimited capacity</div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label class="form-label">Event Notes</label>
                            <select class="form-select mb-2" id="event_note_select" name="event_note_id">
                                <option value="">Do not include an event note</option>
                                {% for note in event_notes %}
                                    <option value="{{ note.id }}" data-note='{{ note.note|tojson }}'{% if event and event.event_note_id == note.id %} selected{% endif %}>{{ note.name }}</option>
                                {% endfor %}
                            </select>
                            <div id="selected_event_note_box" class="border rounded bg-light p-2 mb-2" style="display:none; white-space:pre-line;"></div>
                            <label for="tips_for_attendees" class="form-label">Additional notes for this event</label>
                            <textarea class="form-control" id="tips_for_attendees" name="tips_for_attendees" rows="3"
                                      placeholder="Add any event-specific notes here">{% if event and event.tips_for_attendees %}{{ event.tips_for_attendees }}{% endif %}</textarea>
                            <div class="form-text">You can add extra notes for this event. The selected standard note will be shown above.</div>
                        </div>
                    </div>
                    
                    <!-- Privacy Notice -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Privacy Information</h6>
                        <p class="mb-2">This event will be visible with different levels of detail:</p>
                        <ul class="mb-0">
                            <li><strong>Public visitors:</strong> Can see title, description, area, and time period</li>
                            <li><strong>Approved members:</strong> Can see full address, exact time, and confirm attendance</li>
                            <li><strong>You and other organizers:</strong> Can see attendee list and manage the event</li>
                        </ul>
                    </div>
                    
                    <!-- Submit -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{% if event %}{{ url_for('events.event_detail', event_id=event.id) }}{% else %}{{ url_for('events.events_list') }}{% endif %}" class="btn btn-outline-secondary btn-lg me-md-2">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-{% if is_edit %}save{% else %}calendar-plus{% endif %} me-2"></i>
                            {% if is_edit %}Update Event{% else %}Create Event{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Organizers data from server
const organizersData = {{ organizers|tojson if organizers else "[]" }};

document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const dateInput = document.getElementById('date');
    if (dateInput) {
        const today = new Date().toISOString().split('T')[0];
        // Set value only if it's a new event
        if (!dateInput.value) {
            dateInput.min = today;
            dateInput.value = today;
        }
    }
    
    // Set default time to next hour for new events
    const timeInput = document.getElementById('time');
    const timeHourSelect = document.getElementById('time_hour');
    const timeMinuteSelect = document.getElementById('time_minute');
    
    // Function to update the hidden time input when dropdowns change
    function updateTimeInput() {
        const hour = timeHourSelect.value;
        const minute = timeMinuteSelect.value;
        if (hour && minute) {
            timeInput.value = hour + ':' + minute;
        }
    }
    
    // Add event listeners to time dropdowns
    if (timeHourSelect) {
        timeHourSelect.addEventListener('change', updateTimeInput);
    }
    if (timeMinuteSelect) {
        timeMinuteSelect.addEventListener('change', updateTimeInput);
    }
    
    // Set default time for new events
    if (timeInput && !timeInput.value) {
        const now = new Date();
        now.setHours(now.getHours() + 1, 0, 0, 0);
        const defaultHour = String(now.getHours()).padStart(2, '0');
        const defaultMinute = '00';
        
        if (timeHourSelect) timeHourSelect.value = defaultHour;
        if (timeMinuteSelect) timeMinuteSelect.value = defaultMinute;
        updateTimeInput();
    }
    
    // Load organizers from server data
    loadOrganizers();

    // Setup event notes preview
    setupEventNotes();
});

function setupEventNotes() {
    const select = document.getElementById('event_note_select');
    const noteBox = document.getElementById('selected_event_note_box');

    function updateNotePreview() {
        if (!select) return;
        const selected = select.options[select.selectedIndex];
        let note = selected.getAttribute('data-note');

        if (note && select.value) {
            try {
                note = JSON.parse(note);
            } catch (e) {
                // fallback: use as-is
            }
            
            const lines = note.split(/\r?\n/).slice(0, 5);
            const preview = lines.join('\n');
            const paragraphs = preview.split(/\n\s*\n/);
            
            noteBox.innerHTML = '';
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    const p = document.createElement('p');
                    p.textContent = paragraph;
                    noteBox.appendChild(p);
                }
            });
            noteBox.style.display = 'block';
        } else {
            noteBox.innerHTML = '';
            noteBox.style.display = 'none';
        }
    }

    if (select && noteBox) {
        select.addEventListener('change', updateNotePreview);
        // Initial call to show preview on page load if a note is already selected
        updateNotePreview();
    }
}

function loadOrganizers() {
    const organizerSelect = document.getElementById('organizer_id');
    const coHostSelect = document.getElementById('co_host_id');
    const form = document.querySelector('form');
    
    if (organizersData.length === 0) {
        organizerSelect.innerHTML = '<option value="">No organizers available</option>';
        coHostSelect.innerHTML = '<option value="">No co-host</option>';
        return;
    }
    
    // Clear existing options (except placeholder for co-host)
    organizerSelect.innerHTML = '';
    coHostSelect.innerHTML = '<option value="">No co-host</option>';
    
    // Add organizers to both dropdowns
    organizersData.forEach(organizer => {
        const option1 = document.createElement('option');
        option1.value = organizer.id;
        option1.textContent = `${organizer.name} (${organizer.role})`;
        
        const option2 = document.createElement('option');
        option2.value = organizer.id;
        option2.textContent = `${organizer.name} (${organizer.role})`;
        
        organizerSelect.appendChild(option1);
        coHostSelect.appendChild(option2);
        
        // Select current user as default organizer for new events
        if (organizer.is_current_user && !form.dataset.currentOrganizer) {
            option1.selected = true;
        }
    });
    
    // If we're editing an event, select the current organizer and co-host
    if (form.dataset.currentOrganizer) {
        organizerSelect.value = form.dataset.currentOrganizer;
    }
    if (form.dataset.currentCohost) {
        coHostSelect.value = form.dataset.currentCohost;
    }
    
    // Add validation to prevent same person as organizer and co-host
    function validateOrganizerSelection() {
        const organizerId = organizerSelect.value;
        const coHostId = coHostSelect.value;
        
        if (organizerId && coHostId && organizerId === coHostId) {
            // Show error message
            const errorDiv = document.getElementById('organizer-error') || document.createElement('div');
            errorDiv.id = 'organizer-error';
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>The primary organizer and co-host cannot be the same person.';
            
            // Insert error message after co-host select
            const coHostContainer = coHostSelect.parentElement;
            if (!document.getElementById('organizer-error')) {
                coHostContainer.appendChild(errorDiv);
            }
            
            // Reset co-host selection
            coHostSelect.value = '';
            return false;
        } else {
            // Remove error message if it exists
            const errorDiv = document.getElementById('organizer-error');
            if (errorDiv) {
                errorDiv.remove();
            }
            return true;
        }
    }
    
    // Add event listeners for validation
    organizerSelect.addEventListener('change', validateOrganizerSelection);
    coHostSelect.addEventListener('change', validateOrganizerSelection);
    
    // Add form submission validation
    form.addEventListener('submit', function(e) {
        if (!validateOrganizerSelection()) {
            e.preventDefault();
            return false;
        }
    });
}
// Event Notes dropdown logic
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('event_note_select');
    const noteBox = document.getElementById('selected_event_note_box');
    function updateNotePreview() {
        const selected = select.options[select.selectedIndex];
        let note = selected.getAttribute('data-note');
        if (note && select.value) {
            try {
                note = JSON.parse(note);
            } catch (e) {
                // fallback: use as-is
            }
            let lines = note.split(/\r?\n/).slice(0, 5);
            let html = lines.map(line => line.trim() ? `<p>${line.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : '').join('');
            noteBox.innerHTML = html;
            noteBox.style.display = '';
        } else {
            noteBox.innerHTML = '';
            noteBox.style.display = 'none';
        }
    }
    if (select && noteBox) {
        select.addEventListener('change', updateNotePreview);
        updateNotePreview();
    }
});
</script>
{% endblock %}
