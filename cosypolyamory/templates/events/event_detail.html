{% extends "layout/base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Quick Actions - Top Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('events.events_list') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left me-2"></i>Back to Events
                            </a>
                            
                            {% if current_user.is_authenticated and (current_user.role in ['admin', 'organizer'] or event.organizer_id == current_user.id) %}
                                <a href="{{ url_for('events.edit_event', event_id=event.id) }}" class="btn btn-outline-dark btn-sm">
                                    <i class="fas fa-edit me-2"></i>Edit Event
                                </a>
                            {% endif %}
                            
                            {% if current_user.is_authenticated and current_user.role in ['admin', 'organizer'] %}
                                <a href="{{ url_for('events.create_event') }}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-plus me-2"></i>Create New Event
                                </a>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#shareModal">
                                <i class="fas fa-share me-2"></i>Share Event
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Event Header -->
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-4">
                        <h1 class="card-title mb-0">{{ event.title }}</h1>
                        {% if event.exact_time < now %}
                            <span class="badge bg-secondary fs-6">Past Event</span>
                        {% else %}
                            <span class="badge bg-primary fs-6">Upcoming</span>
                        {% endif %}
                    </div>
                    
                    <!-- Date and Location Row - moved under title -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar me-2 text-primary"></i>Date</h6>
                            <p>{{ event.exact_time.strftime('%A, %B %d, %Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-map-marker-alt me-2 text-primary"></i>Location</h6>
                            {% if can_see_details %}
                                <p>{{ event.establishment_name }}</p>
                            {% else %}
                                <p>{{ event.barrio }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-info-circle me-2 text-primary"></i>Description</h6>
                            <div class="card-text">
                                {% if event.description %}
                                    {% for paragraph in event.description.split('\n') %}
                                        {% if paragraph.strip() %}
                                            <p>{{ paragraph.strip() }}</p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attendees Section -->
                    <!-- Attendance Confirmation Section -->
                    {% if can_see_details and event.exact_time > now %}
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calendar-check me-2"></i>
                                        Attendance Confirmation
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if user_rsvp %}
                                        {% if user_rsvp.status == 'yes' %}
                                        <div class="text-center">
                                            <p><i class="fas fa-check-circle text-success me-2"></i>You've confirmed you're attending this event.</p>
                                            <button id="not-attending-btn" class="btn btn-outline-danger" data-event-id="{{ event.id }}" data-status="no">
                                                <i class="fas fa-times me-2"></i>I can't go
                                            </button>
                                        </div>
                                        {% else %}
                                        <div class="text-center">
                                            <p><i class="fas fa-times-circle text-danger me-2"></i>You've said you can't attend this event.</p>
                                            <button id="attending-btn" class="btn btn-success" data-event-id="{{ event.id }}" data-status="yes">
                                                <i class="fas fa-check me-2"></i>I can now go!
                                            </button>
                                        </div>
                                        {% endif %}
                                    {% else %}
                                        {% if event.max_attendees and rsvp_count >= event.max_attendees %}
                                        <div class="text-center">
                                            <p class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>This event is full.</p>
                                        </div>
                                        {% else %}
                                        <div class="text-center">
                                            <p>Will you be attending this event?</p>
                                            <div class="btn-group" role="group">
                                                <button id="attending-btn" class="btn btn-success" data-event-id="{{ event.id }}" data-status="yes">
                                                    <i class="fas fa-check me-2"></i>I want to go!
                                                </button>
                                                <button id="not-attending-btn" class="btn btn-outline-danger" data-event-id="{{ event.id }}" data-status="no">
                                                    <i class="fas fa-times me-2"></i>I can't go
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if (rsvps or rsvps_no) and can_see_details %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-users me-2"></i>
                                        Event Responses
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-success mb-3">
                                                <i class="fas fa-check me-2"></i>
                                                Attendees ({{ rsvp_count }})
                                            </h6>
                                            <div style="max-height: 250px; overflow-y: auto;">
                                                {% if rsvps %}
                                                    {% for rsvp in rsvps %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="me-2">
                                                                <i class="fas fa-user-circle fa-lg text-success"></i>
                                                            </div>
                                                            <div>
                                                                <strong>{{ rsvp.user.name }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    Confirmed {{ rsvp.created_at.strftime('%b %d') }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="text-muted text-center py-3">
                                                        <i class="fas fa-users fa-2x mb-2"></i>
                                                        <p>No one has confirmed attendance yet.</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 border-start">
                                            <h6 class="text-danger mb-3">
                                                <i class="fas fa-times me-2"></i>
                                                Not Attending ({{ rsvp_no_count }})
                                            </h6>
                                            <div style="max-height: 250px; overflow-y: auto;">
                                                {% if rsvps_no %}
                                                    {% for rsvp in rsvps_no %}
                                                        <div class="d-flex align-items-center mb-2">
                                                            <div class="me-2">
                                                                <i class="fas fa-user-circle fa-lg text-danger"></i>
                                                            </div>
                                                            <div>
                                                                <strong>{{ rsvp.user.name }}</strong>
                                                                <br>
                                                                <small class="text-muted">
                                                                    Confirmed {{ rsvp.created_at.strftime('%b %d') }}
                                                                </small>
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="text-muted text-center py-3">
                                                        <i class="fas fa-user-times fa-2x mb-2"></i>
                                                        <p>No one has said they can't attend.</p>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if not can_see_details %}
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Exact time and location details are visible to approved members only.</strong>
                                {% if not current_user.is_authenticated %}
                                <br><small>Login and apply to join the community to access full event details and RSVP.</small>
                                {% elif current_user.role in ['pending', 'rejected'] %}
                                <br><small>Apply to join the community to access full event details and RSVP.</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    
                    <!-- Event Details -->
                    <div class="row mt-4">
                        
                        <!-- Capacity Information -->
                        {% if event.max_attendees %}
                        <div class="col-12 mt-3">
                            <h6><i class="fas fa-users me-2 text-primary"></i>Capacity</h6>
                            <p>{{ rsvp_count }}/{{ event.max_attendees }} attendees</p>
                            <div class="progress mb-2" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ (rsvp_count / event.max_attendees * 100) if event.max_attendees else 0 }}%"></div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    {% if current_user.is_authenticated and current_user.role not in ['pending', 'rejected'] %}
                    <!-- Google Maps Preview - full width under time/location -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mt-4"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Event Location</h6>
                            {% if google_maps_api_key and google_maps_info %}
                                {% if google_maps_info.lat and google_maps_info.lng %}
                                    <!-- Embedded Google Maps with coordinates -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/view?key={{ google_maps_api_key }}&center={{ google_maps_info.lat }},{{ google_maps_info.lng }}&zoom=15">
                                    </iframe>
                                {% elif google_maps_info.place_name %}
                                    <!-- Embedded Google Maps with place name -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q={{ google_maps_info.place_name | urlencode }}">
                                    </iframe>
                                {% elif google_maps_info.embed_url %}
                                    <!-- Embedded Google Maps with URL (for short URLs like goo.gl) -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="{{ google_maps_info.embed_url }}">
                                    </iframe>
                                {% elif google_maps_info.search_url %}
                                    <!-- Use Google Maps Embed API search mode for short URLs -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/search?key={{ google_maps_api_key }}&q={{ google_maps_info.search_url | urlencode }}">
                                    </iframe>
                                {% else %}
                                    <!-- Fallback: show placeholder if we can't parse the URL -->
                                    <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-map fa-3x mb-2"></i>
                                            <br>
                                            <small>Unable to parse map location</small>
                                        </div>
                                    </div>
                                {% endif %}
                            {% elif event.google_maps_link %}
                                <!-- No API key configured - show placeholder -->
                                <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-map fa-3x mb-2"></i>
                                        <br>
                                        <small>Map preview will be available when Google Maps API is configured</small>
                                    </div>
                                </div>
                            {% else %}
                                <!-- No Google Maps link provided -->
                                <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-map-marker-alt fa-3x mb-2"></i>
                                        <br>
                                        <small>No map location provided for this event</small>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if event.google_maps_link %}
                            <div class="mt-2">
                                <a href="{{ event.google_maps_link }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>Open in Google Maps
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Hosts Section -->
                    {% if can_see_details %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Host</h6>
                            <div class="d-flex align-items-center mb-2">
                                {% if event.organizer.avatar_url %}
                                    <img src="{{ event.organizer.avatar_url }}" alt="{{ event.organizer.name }}" 
                                         class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px; display: none;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ event.organizer.name }}</strong>
                                </div>
                            </div>
                        </div>
                        {% if event.co_host %}
                        <div class="col-md-6">
                            <h6>Co-host</h6>
                            <div class="d-flex align-items-center mb-2">
                                {% if event.co_host.avatar_url %}
                                    <img src="{{ event.co_host.avatar_url }}" alt="{{ event.co_host.name }}" 
                                         class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;"
                                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px; display: none;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% else %}
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ event.co_host.name }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Important notes about our events Section -->
                    {% if event.event_note or (event.tips_for_attendees and event.tips_for_attendees.strip()) %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-warning bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                            Important notes about our events
                                        </h5>
                                        <div class="card-text">
                                            {% if event.event_note %}
                                                {% for paragraph in event.event_note.note.split('\n\n') %}
                                                    {% if paragraph.strip() %}
                                                        <p>{{ paragraph.strip() }}</p>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            {% if event.event_note and event.tips_for_attendees and event.tips_for_attendees.strip() %}
                                                <p></p>
                                            {% endif %}
                                            {% if event.tips_for_attendees and event.tips_for_attendees.strip() %}
                                                {% for paragraph in event.tips_for_attendees.split('\n\n') %}
                                                    {% if paragraph.strip() %}
                                                        <p>{{ paragraph.strip() | replace('\n', '<br>') | safe }}</p>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Member-only notice -->
                    {% if not can_see_details %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Want to attend events?</h6>
                                <p class="mb-2">You need to be an approved community member to confirm your attendance at events.</p>
                                {% if not current_user.is_authenticated %}
                                    <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login to Apply
                                    </a>
                                {% elif current_user.role == 'rejected' %}
                                    <p class="text-muted">Your application was not approved.</p>
                                {% elif not current_user.application %}
                                    <a href="{{ url_for('user.apply') }}" class="btn btn-primary">
                                        <i class="fas fa-edit me-2"></i>Apply to Join Community
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('user.application_status') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-clock me-2"></i>Check Application Status
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Event Stats (full width) -->
            {% if current_user.is_authenticated %}
            <div class="row mt-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Event Stats
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-success">{{ rsvp_count }}</h4>
                                    <small class="text-muted">Going</small>
                                </div>
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-danger">{{ rsvp_no_count or 0 }}</h4>
                                    <small class="text-muted">Can't Go</small>
                                </div>
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-info">{{ views_count or 0 }}</h4>
                                    <small class="text-muted">Views</small>
                                </div>
                                <div class="col-6 col-md-3 mb-3 mb-md-0">
                                    <h4 class="text-primary">{{ event.max_attendees or '‚àû' }}</h4>
                                    <small class="text-muted">Max Capacity</small>
                                </div>
                                <div class="col-12 col-md-3">
                                    <h4 class="text-warning">{{ ((event.max_attendees - rsvp_count) if event.max_attendees else '‚àû') }}</h4>
                                    <small class="text-muted">Spots Left</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
    </div>
</div>

<!-- Share Event Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share me-2"></i>Share Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Choose the format you'd like to copy and share:</p>
                
                <!-- Format Selection Tabs -->
                <ul class="nav nav-tabs mb-3" id="shareFormatTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="plain-tab" data-bs-toggle="tab" data-bs-target="#plain-content" type="button" role="tab">
                            <i class="fas fa-file-alt me-2"></i>Plain Text
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-content" type="button" role="tab">
                            <i class="fab fa-html5 me-2"></i>HTML
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="markdown-tab" data-bs-toggle="tab" data-bs-target="#markdown-content" type="button" role="tab">
                            <i class="fab fa-markdown me-2"></i>Markdown
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="shareFormatTabsContent">
                    <!-- Plain Text -->
                    <div class="tab-pane fade show active" id="plain-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Plain Text Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('plain-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="plain-text" class="form-control share-text" rows="8" readonly>{{ event.title }}

Date: {{ event.exact_time.strftime('%A, %B %d, %Y') }}
Approximate time: Morning
Location: {{ event.barrio }}

{{ event.description }}

Log in or join our community for more details: {{ request.url }}</textarea>
                    </div>
                    
                    <!-- HTML -->
                    <div class="tab-pane fade" id="html-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>HTML Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('html-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="html-text" class="form-control share-text" rows="8" readonly><h2>{{ event.title | e }}</h2>

<p><strong>üìÖ Date:</strong> {{ event.exact_time.strftime('%A, %B %d, %Y') }}</p>
<p><strong>üïê Approximate time:</strong> Morning</p>
<p><strong>üìç Location:</strong> {{ event.barrio | e }}</p>

<div>{{ event.description | safe }}</div>

<p><a href="{{ request.url }}">Log in or join our community for more details</a></p></textarea>
                    </div>
                    
                    <!-- Markdown -->
                    <div class="tab-pane fade" id="markdown-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Markdown Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('markdown-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="markdown-text" class="form-control share-text" rows="8" readonly>## {{ event.title }}

**üìÖ Date:** {{ event.exact_time.strftime('%A, %B %d, %Y') }}
**üïê Approximate time:** Morning
**üìç Location:** {{ event.barrio }}

{{ event.description }}

[Log in or join our community for more details]({{ request.url }})</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
.bg-orange { background-color: #fd7e14 !important; }
.bg-purple { background-color: #6f42c1 !important; }
/* Make the map responsive */
#map {
    height: 400px;
    width: 100%;
}
.share-text {
    white-space: pre-wrap;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const attendingBtn = document.getElementById('attending-btn');
    const notAttendingBtn = document.getElementById('not-attending-btn');
    const eventId = {{ event.id }};
    
    function updateAttendanceStatus(status, button) {
        // Show loading state
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        
        // Make AJAX request
        fetch(`/events/${eventId}/rsvp`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: `status=${status}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateButtonStates(data.status);
                showMessage(data.message, 'success');
                
                // Update page title message
                const attendanceSection = document.getElementById('attendance-section');
                const titleElement = attendanceSection.querySelector('h5');
                if (status === 'yes') {
                    titleElement.innerHTML = '<i class="fas fa-check-circle me-2"></i>You\'re going to this event!';
                    titleElement.className = 'text-success';
                } else if (status === 'no') {
                    titleElement.innerHTML = '<i class="fas fa-times-circle me-2"></i>You can\'t make this event';
                    titleElement.className = 'text-muted';
                }
            } else {
                showMessage(data.message, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while updating your attendance.', 'error');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
    
    function updateButtonStates(status) {
        if (status === 'yes') {
            // User is going - green solid button for "I'm going", outline for "I can't"
            attendingBtn.className = 'btn btn-success btn-lg me-2';
            attendingBtn.innerHTML = '<i class="fas fa-check me-2"></i>I\'m going';
            attendingBtn.disabled = true;
            attendingBtn.removeAttribute('data-status');
            
            notAttendingBtn.className = 'btn btn-outline-danger btn-lg';
            notAttendingBtn.innerHTML = '<i class="fas fa-times me-2"></i>I can\'t go';
            notAttendingBtn.disabled = false;
            notAttendingBtn.setAttribute('data-status', 'no');
        } else if (status === 'no') {
            // User can't go - outline for "I want to go!", solid red for "I can't"
            attendingBtn.className = 'btn btn-outline-success btn-lg me-2';
            attendingBtn.innerHTML = '<i class="fas fa-check me-2"></i>I want to go!';
            attendingBtn.disabled = false;
            attendingBtn.setAttribute('data-status', 'yes');
            
            notAttendingBtn.className = 'btn btn-danger btn-lg';
            notAttendingBtn.innerHTML = '<i class="fas fa-times me-2"></i>I can\'t';
            notAttendingBtn.disabled = true;
            notAttendingBtn.removeAttribute('data-status');
        }
    }
    
    function showMessage(message, type) {
        // Create a simple alert message
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert the message at the top of the attendance section
        const attendanceSection = document.getElementById('attendance-section');
        attendanceSection.insertBefore(alertDiv, attendanceSection.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
    
    // Attach event listeners
    if (attendingBtn) {
        attendingBtn.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            if (status) {
                updateAttendanceStatus(status, this);
            }
        });
    }
    
    if (notAttendingBtn) {
        notAttendingBtn.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            if (status) {
                updateAttendanceStatus(status, this);
            }
        });
    }
});

// Copy to clipboard function for share modal
function copyToClipboard(elementId) {
    const textarea = document.getElementById(elementId);
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-primary');
        }, 2000);
        
    } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(textarea.value).then(() => {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
        }).catch(() => {
            alert('Could not copy to clipboard. Please select and copy manually.');
        });
    }
}
</script>
{% endblock %}
