{% extends "layout/base.html" %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Quick Actions - Top Row -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-3">
                    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{{ url_for('events.events_list') }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left me-2"></i>Back to Events
                            </a>
                            
                            {% if current_user.is_authenticated and (current_user.role in ['admin', 'organizer'] or event.organizer_id == current_user.id) %}
                                <a href="{{ url_for('events.edit_event', event_id=event.id) }}" class="btn btn-outline-dark btn-sm">
                                    <i class="fas fa-edit me-2"></i>Edit Event
                                </a>
                            {% endif %}
                            
                            {% if current_user.is_authenticated and current_user.role in ['admin', 'organizer'] %}
                                <a href="{{ url_for('events.create_event') }}" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-plus me-2"></i>Create New Event
                                </a>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#shareModal">
                                <i class="fas fa-share me-2"></i>Share Event
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Event Header -->
            <div class="card">
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-2 justify-content-end mb-3">
                                <span id="header-pills">
                                {% if event.exact_time < now %}
                                    <span class="badge bg-secondary fs-6">Past Event</span>
                                {% else %}
                                    {% if event.max_attendees and rsvp_count >= event.max_attendees %}
                                        <span class="badge bg-warning text-dark align-middle">Full</span>
                                    {% endif %}
                                    {% if rsvps_waitlist and rsvps_waitlist|length > 0 %}
                                        <span class="badge bg-secondary align-middle ms-2">Waitlist</span>
                                    {% endif %}
                                    <span class="badge bg-primary fs-6 ms-2">Upcoming</span>
                                {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-12">
                            <h1 class="card-title mb-0">{{ event.title }}</h1>
                        </div>
                    </div>

                    <!-- Hosts Section -->
                    {% if can_see_details %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Host</h6>
                            <div class="d-flex align-items-center mb-2">
                                {% if event.organizer.avatar_url %}
                                    <span class="position-relative d-inline-block me-3" style="width: 40px; height: 40px;">
                                        <img src="{{ event.organizer.avatar_url }}" alt="{{ event.organizer.name }}"
                                             class="rounded-circle position-absolute top-0 start-0" style="width: 40px; height: 40px; object-fit: cover; z-index:2;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center position-absolute top-0 start-0" 
                                             style="width: 40px; height: 40px; display: none; z-index:1;">
                                            <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                        </div>
                                    </span>
                                {% else %}
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ event.organizer.name }}</strong>
                                </div>
                            </div>
                        </div>
                        {% if event.co_host %}
                        <div class="col-md-6">
                            <h6>Co-host</h6>
                            <div class="d-flex align-items-center mb-2">
                                {% if event.co_host.avatar_url %}
                                    <span class="position-relative d-inline-block me-3" style="width: 40px; height: 40px;">
                                        <img src="{{ event.co_host.avatar_url }}" alt="{{ event.co_host.name }}"
                                             class="rounded-circle position-absolute top-0 start-0" style="width: 40px; height: 40px; object-fit: cover; z-index:2;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center position-absolute top-0 start-0" 
                                             style="width: 40px; height: 40px; display: none; z-index:1;">
                                            <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                        </div>
                                    </span>
                                {% else %}
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-user text-white" style="font-size: 16px;"></i>
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ event.co_host.name }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Event Details Section -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <h6><i class="fas fa-calendar-day me-2 text-primary"></i>Date</h6>
                            <p>{{ event.exact_time.strftime('%A, %b %d, %Y') }}</p>
                        </div>
                        <div class="col-md-3">
                            <h6><i class="fas fa-clock me-2 text-primary"></i>Time</h6>
                            {% if can_see_details %}
                                <p>{{ event.exact_time.strftime('%H:%M') }}
                                    {% if event.time_period %} <span class="text-muted">({{ event.time_period }})</span>{% endif %}
                                    {% if event.public_time_period %} <span class="text-muted">({{ event.public_time_period }})</span>{% endif %}
                                </p>
                            {% else %}
                                <p>{{ event.time_period }}{% if event.public_time_period %} <span class="text-muted">({{ event.public_time_period }})</span>{% endif %}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-5">
                            <h6><i class="fas fa-map-marker-alt me-2 text-primary"></i>Location</h6>
                            {% if can_see_details %}
                                <p>{{ event.establishment_name }}{% if event.barrio %} <span class="text-muted">({{ event.barrio }})</span>{% endif %}</p>
                            {% else %}
                                <p>{{ event.barrio }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Description Section -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-info-circle me-2 text-primary"></i>Description</h6>
                            <div class="card-text">
                                {% if event.description %}
                                    {% for paragraph in event.description.split('\n') %}
                                        {% if paragraph.strip() %}
                                            <p>{{ paragraph.strip() }}</p>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Important notes about our events Section -->
                    {% if event.event_note or (event.tips_for_attendees and event.tips_for_attendees.strip()) %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-warning bg-light">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                            Important notes about our events
                                        </h5>
                                        <div class="card-text">
                                            {% if event.event_note %}
                                                {% for paragraph in event.event_note.note.split('\n\n') %}
                                                    {% if paragraph.strip() %}
                                                        <p>{{ paragraph.strip() | replace('\n', '<br>') | safe }}</p>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            {% if event.event_note and event.tips_for_attendees and event.tips_for_attendees.strip() %}
                                                <p></p>
                                            {% endif %}
                                            {% if event.tips_for_attendees and event.tips_for_attendees.strip() %}
                                                {% for paragraph in event.tips_for_attendees.split('\n\n') %}
                                                    {% if paragraph.strip() %}
                                                        <p>{{ paragraph.strip() | replace('\n', '<br>') | safe }}</p>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if current_user.is_authenticated and current_user.role not in ['pending', 'rejected'] %}
                    <!-- Google Maps Preview - full width under time/location -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mt-4"><i class="fas fa-map-marker-alt me-2 text-primary"></i>Event Location</h6>
                            {% if google_maps_api_key and google_maps_info %}
                                {% if google_maps_info.lat and google_maps_info.lng %}
                                    <!-- Embedded Google Maps with coordinates -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/view?key={{ google_maps_api_key }}&center={{ google_maps_info.lat }},{{ google_maps_info.lng }}&zoom=15">
                                    </iframe>
                                {% elif google_maps_info.place_name %}
                                    <!-- Embedded Google Maps with place name -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/place?key={{ google_maps_api_key }}&q={{ google_maps_info.place_name | urlencode }}">
                                    </iframe>
                                {% elif google_maps_info.embed_url %}
                                    <!-- Embedded Google Maps with URL (for short URLs like goo.gl) -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="{{ google_maps_info.embed_url }}">
                                    </iframe>
                                {% elif google_maps_info.search_url %}
                                    <!-- Use Google Maps Embed API search mode for short URLs -->
                                    <iframe
                                        width="100%"
                                        height="200"
                                        style="border:0; border-radius: 0.375rem;"
                                        loading="lazy"
                                        allowfullscreen
                                        referrerpolicy="no-referrer-when-downgrade"
                                        src="https://www.google.com/maps/embed/v1/search?key={{ google_maps_api_key }}&q={{ google_maps_info.search_url | urlencode }}">
                                    </iframe>
                                {% else %}
                                    <!-- Fallback: show placeholder if we can't parse the URL -->
                                    <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                        <div class="text-center text-muted">
                                            <i class="fas fa-map fa-3x mb-2"></i>
                                            <br>
                                            <small>Unable to parse map location</small>
                                        </div>
                                    </div>
                                {% endif %}
                            {% elif event.google_maps_link %}
                                <!-- No API key configured - show placeholder -->
                                <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-map fa-3x mb-2"></i>
                                        <br>
                                        <small>Map preview will be available when Google Maps API is configured</small>
                                    </div>
                                </div>
                            {% else %}
                                <!-- No Google Maps link provided -->
                                <div class="border rounded" style="height: 200px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-map-marker-alt fa-3x mb-2"></i>
                                        <br>
                                        <small>No map location provided for this event</small>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if event.google_maps_link %}
                            <div class="mt-2">
                                <a href="{{ event.google_maps_link }}" target="_blank" class="btn btn-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>Open in Google Maps
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    
                    {% endif %}
                    
                    <!-- Attendees Section -->
                    
                    <!-- Event Attendance & Responses -->
                    {% if can_see_details %}
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-users me-2"></i>
                                        Event Attendance
                                    </h6>
                                </div>
                                <div class="card-body">
                                    
                                    <!-- Attendance Buttons -->
                                    {% if event.exact_time > now %}
                                    <div class="mb-4" id="attendance-section">
                                        {% set user_rsvp = user_rsvp %}
                                        <div class="text-center">
                                            <div class="rsvp-status-line mt-2 mb-3">
                                                {% if user_rsvp %}
                                                    {% if user_rsvp.status == 'yes' %}
                                                        <i class="fas fa-check-circle text-secondary me-2" title="RSVP Status"></i>
                                                        <span class="fw-bold text-success">I'm going</span>
                                                    {% elif user_rsvp.status == 'no' %}
                                                        <i class="fas fa-times-circle text-secondary me-2" title="RSVP Status"></i>
                                                        <span class="fw-bold text-danger">I'm not going</span>
                                                    {% elif user_rsvp.status == 'waitlist' %}
                                                        <i class="fas fa-hourglass-half text-secondary me-2" title="RSVP Status"></i>
                                                        <span class="fw-bold text-warning">I am waitlisted</span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            <div class="d-flex gap-2 justify-content-center" role="group">
                                                {% if not user_rsvp %}
                                                    <button class="btn btn-success attendance-btn" data-event-id="{{ event.id }}" data-status="yes" style="min-width: 140px;">
                                                        <i class="fas fa-check me-2"></i>I want to go!
                                                    </button>
                                                    <button class="btn btn-danger attendance-btn" data-event-id="{{ event.id }}" data-status="no" style="min-width: 120px;">
                                                        <i class="fas fa-times me-2"></i>I can't go
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-success attendance-btn" data-event-id="{{ event.id }}" data-status="yes" {% if user_rsvp.status == 'yes' or user_rsvp.status == 'waitlist' %}disabled{% endif %} style="min-width: 140px;">
                                                        <i class="fas fa-check me-2"></i>I want to go!
                                                    </button>
                                                    <button class="btn btn-danger attendance-btn" data-event-id="{{ event.id }}" data-status="no" {% if user_rsvp.status == 'no' %}disabled{% endif %} style="min-width: 120px;">
                                                        <i class="fas fa-times me-2"></i>I can't go
                                                    </button>
                                                {% endif %}
                                            </div>
                                            
                                            <!-- Add to Calendar Button -->
                                            <div class="text-center mt-3">
                                                <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#addToCalendarModal">
                                                    <i class="fas fa-calendar-plus me-2"></i>Add to Calendar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Capacity Information -->
                                    {% if event.max_attendees %}
                                    <div class="mb-4 border-top pt-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-bold">Capacity:</span>
                                            <span>
                                                {{ rsvp_count }}/{{ event.max_attendees }} attendees
                                                <span id="capacity-pills">
                                                    {% if rsvp_count >= event.max_attendees %}
                                                        <span class="badge bg-warning text-dark ms-2 align-middle">Full</span>
                                                    {% endif %}
                                                    {% if rsvps_waitlist and rsvps_waitlist|length > 0 %}
                                                        <span class="badge bg-secondary ms-2 align-middle">Waitlist</span>
                                                    {% endif %}
                                                </span>
                                            </span>
                                        </div>
                                        <div class="progress mb-3" style="height: 8px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ (rsvp_count / event.max_attendees * 100) if event.max_attendees else 0 }}%"></div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Event Responses Lists -->
                                    <div class="border-top pt-4">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6 class="text-success mb-3" id="attendee-count-header">
                                                    <i class="fas fa-check me-2"></i>
                                                    Attendees ({{ rsvp_count }})
                                                </h6>
                                                <div style="max-height: 250px; overflow-y: auto;">
                                                    {% include 'events/event_detail_attendees.html' %}
                                                </div>
                                            </div>
                                            <div class="col-md-4 border-start">
                                                <h6 class="text-warning mb-3" id="waitlist-count-header">
                                                    <i class="fas fa-user-clock me-2"></i>
                                                    Waitlist ({{ rsvps_waitlist|length }})
                                                </h6>
                                                <div style="max-height: 250px; overflow-y: auto;">
                                                    {% include 'events/event_detail_waitlist.html' %}
                                                </div>
                                            </div>
                                            <div class="col-md-4 border-start">
                                                <h6 class="text-danger mb-3" id="not-attending-count-header">
                                                    <i class="fas fa-times me-2"></i>
                                                    Not Attending ({{ rsvp_no_count }})
                                                </h6>
                                                <div style="max-height: 250px; overflow-y: auto;">
                                                    {% include 'events/event_detail_not_attending.html' %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Edit Attendance Button for Admins/Organizers -->
                                    {% if current_user.is_authenticated and (current_user.role in ['admin', 'organizer']) %}
                                    <div class="border-top pt-3 mt-3">
                                        <div class="text-center">
                                            <a href="{{ url_for('events.edit_attendance', event_id=event.id) }}" class="btn btn-outline-primary">
                                                <i class="fas fa-users-cog me-2"></i>Edit Attendance
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% if not can_see_details %}
                    <div class="row mt-4 mb-4">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Exact time and location details are visible to approved members only.</strong>
                                {% if not current_user.is_authenticated %}
                                <br><small>Login and apply to join the community to access full event details and RSVP.</small>
                                {% elif current_user.role in ['pending', 'rejected'] %}
                                <br><small>Apply to join the community to access full event details and RSVP.</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    
                    
                    <!-- Member-only notice -->
                    {% if not can_see_details %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>Want to attend events?</h6>
                                <p class="mb-2">You need to be an approved community member to confirm your attendance at events.</p>
                                {% if not current_user.is_authenticated %}
                                    <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login to Apply
                                    </a>
                                {% elif current_user.role == 'rejected' %}
                                    <p class="text-muted">Your application was not approved.</p>
                                {% elif not current_user.application %}
                                    <a href="{{ url_for('user.apply') }}" class="btn btn-primary">
                                        <i class="fas fa-edit me-2"></i>Apply to Join Community
                                    </a>
                                {% else %}
                                    <a href="{{ url_for('user.application_status') }}" class="btn btn-outline-primary">
                                        <i class="fas fa-clock me-2"></i>Check Application Status
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Event Stats (full width) -->
            {% if current_user.is_authenticated %}
            <div class="row mt-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>
                                Event Stats
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-success">{{ rsvp_count }}</h4>
                                    <small class="text-muted">Going</small>
                                </div>
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-danger">{{ rsvp_no_count or 0 }}</h4>
                                    <small class="text-muted">Can't Go</small>
                                </div>
                                <div class="col-6 col-md-2 mb-3 mb-md-0">
                                    <h4 class="text-info">{{ views_count or 0 }}</h4>
                                    <small class="text-muted">Views</small>
                                </div>
                                <div class="col-6 col-md-3 mb-3 mb-md-0">
                                    <h4 class="text-primary">{{ event.max_attendees or '‚àû' }}</h4>
                                    <small class="text-muted">Max Capacity</small>
                                </div>
                                <div class="col-12 col-md-3">
                                    <h4 class="text-warning">{{ ((event.max_attendees - rsvp_count) if event.max_attendees else '‚àû') }}</h4>
                                    <small class="text-muted">Spots Left</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
    </div>
</div>

<!-- Share Event Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="fas fa-share me-2"></i>Share Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-4">Choose the format you'd like to copy and share:</p>
                
                <!-- Format Selection Tabs -->
                <ul class="nav nav-tabs mb-3" id="shareFormatTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="plain-tab" data-bs-toggle="tab" data-bs-target="#plain-content" type="button" role="tab">
                            <i class="fas fa-file-alt me-2"></i>Plain Text
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="html-tab" data-bs-toggle="tab" data-bs-target="#html-content" type="button" role="tab">
                            <i class="fab fa-html5 me-2"></i>HTML
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="markdown-tab" data-bs-toggle="tab" data-bs-target="#markdown-content" type="button" role="tab">
                            <i class="fab fa-markdown me-2"></i>Markdown
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="shareFormatTabsContent">
                    <!-- Plain Text -->
                    <div class="tab-pane fade show active" id="plain-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Plain Text Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('plain-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="plain-text" class="form-control share-text" rows="8" readonly>{{ event.title }}

Date: {{ event.exact_time.strftime('%A, %B %d, %Y') }}
{% if can_see_details %}Time: {{ event.exact_time.strftime('%H:%M') }}
Location: {{ event.establishment_name }}{% else %}Approximate time: {{ event.time_period }}
Location: {{ event.barrio }}{% endif %}

{{ event.description }}

Log in or join our community for more details: {{ request.url }}</textarea>
                    </div>
                    
                    <!-- HTML -->
                    <div class="tab-pane fade" id="html-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>HTML Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('html-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="html-text" class="form-control share-text" rows="8" readonly><h2>{{ event.title | e }}</h2>

<p><strong>üìÖ Date:</strong> {{ event.exact_time.strftime('%A, %B %d, %Y') }}</p>
<p><strong>üïê Approximate time:</strong> Morning</p>
<p><strong>üìç Location:</strong> {{ event.barrio | e }}</p>

<div>{{ event.description | safe }}</div>

<p><a href="{{ request.url }}">Log in or join our community for more details</a></p></textarea>
                    </div>
                    
                    <!-- Markdown -->
                    <div class="tab-pane fade" id="markdown-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>Markdown Format:</strong>
                            <button type="button" class="btn btn-primary btn-sm" onclick="copyToClipboard('markdown-text')">
                                <i class="fas fa-copy me-2"></i>Copy
                            </button>
                        </div>
                        <textarea id="markdown-text" class="form-control share-text" rows="8" readonly>## {{ event.title }}

**üìÖ Date:** {{ event.exact_time.strftime('%A, %B %d, %Y') }}
{% if can_see_details %}**üïê Time:** {{ event.exact_time.strftime('%H:%M') }}
**üìç Location:** {{ event.establishment_name }}{% else %}**üïê Approximate time:** {{ event.time_period }}
**üìç Location:** {{ event.barrio }}{% endif %}

{{ event.description }}

[Log in or join our community for more details]({{ request.url }})</textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
.bg-orange { background-color: #fd7e14 !important; }
.bg-purple { background-color: #6f42c1 !important; }
/* Make the map responsive */
#map {
    height: 400px;
    width: 100%;
}
.share-text {
    white-space: pre-wrap;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
}
</style>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
console.log('RSVP script loaded');
document.addEventListener('DOMContentLoaded', function() {
    let eventId = "{{ event.id }}";

    // Use event delegation instead of direct attachment
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('attendance-btn') || e.target.closest('.attendance-btn')) {
            const button = e.target.classList.contains('attendance-btn') ? e.target : e.target.closest('.attendance-btn');
            console.log('RSVP button clicked', button, button.getAttribute('data-status'));
            const status = button.getAttribute('data-status');
            if (status && !button.disabled) {
                updateAttendanceStatus(status, button);
            }
        }
    });

    function updateAttendanceStatus(status, button) {
        // Show loading state with fixed width to prevent jiggling
        const originalText = button.innerHTML;
        const originalWidth = button.offsetWidth;
        button.disabled = true;
        button.style.width = originalWidth + 'px';
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

        // Make AJAX request
        fetch(`/events/${eventId}/rsvp`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: `status=${status}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // DOM is replaced, so no need to restore button state
                updateAttendanceUI(data);
            } else {
                showMessage(data.message, 'error');
                // Only restore if button is still in DOM
                if (document.body.contains(button)) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred while updating your attendance.', 'error');
            if (document.body.contains(button)) {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }

    function updateAttendanceUI(data) {
        console.log('RSVP data received - rsvp_count:', data.rsvp_count, 'rsvp_no_count:', data.rsvp_no_count);
        if (data.waitlist_html) console.log('Has waitlist_html');
        if (data.waitlist_count) console.log('Has waitlist_count:', data.waitlist_count);

        // Update the attendance section
        const section = document.getElementById('attendance-section');
        if (!section) return;
        let html = '';
        if (data.user_rsvp) {
            let statusLine = '';
            if (data.user_rsvp.status === 'yes') {
                statusLine = `<i class=\"fas fa-check-circle text-secondary me-2\" title=\"RSVP Status\"></i><span class=\"fw-bold text-success\">I'm going</span>`;
            } else if (data.user_rsvp.status === 'no') {
                statusLine = `<i class=\"fas fa-times-circle text-secondary me-2\" title=\"RSVP Status\"></i><span class=\"fw-bold text-danger\">I'm not going</span>`;
            } else if (data.user_rsvp.status === 'waitlist') {
                statusLine = `<i class=\"fas fa-hourglass-half text-secondary me-2\" title=\"RSVP Status\"></i><span class=\"fw-bold text-warning\">I am waitlisted</span>`;
            }
            html += `<div class=\"text-center\"><div class=\"rsvp-status-line mt-2 mb-2\">${statusLine}</div><div class=\"d-flex gap-2 justify-content-center\" role=\"group\">` +
                `<button class=\"btn btn-success attendance-btn\" data-event-id=\"${eventId}\" data-status=\"yes\" style=\"min-width: 140px;\" ${(data.user_rsvp.status === 'yes' || data.user_rsvp.status === 'waitlist') ? 'disabled' : ''}>` +
                `<i class=\"fas fa-check me-2\"></i>I want to go!</button>` +
                `<button class=\"btn btn-danger attendance-btn\" data-event-id=\"${eventId}\" data-status=\"no\" style=\"min-width: 120px;\" ${(data.user_rsvp.status === 'no') ? 'disabled' : ''}>` +
                `<i class=\"fas fa-times me-2\"></i>I can't go</button></div></div>`;
        } else {
            html += `<div class=\"text-center\"><div class=\"d-flex gap-2 justify-content-center\" role=\"group\">` +
                `<button class=\"btn btn-success attendance-btn\" data-event-id=\"${eventId}\" data-status=\"yes\" style=\"min-width: 140px;\">` +
                `<i class=\"fas fa-check me-2\"></i>I want to go!</button>` +
                `<button class=\"btn btn-danger attendance-btn\" data-event-id=\"${eventId}\" data-status=\"no\" style=\"min-width: 120px;\">` +
                `<i class=\"fas fa-times me-2\"></i>I can't go</button></div></div>`;
        }
        section.innerHTML = html;

        // No need to re-attach event listeners since we're using event delegation

        // Update attendee, not attending, and waitlist lists and counts
        if (data.rsvps_html) {
            const attendeesCol = document.querySelector('h6#attendee-count-header + div');
            if (attendeesCol) attendeesCol.innerHTML = data.rsvps_html;
        }
        if (data.rsvps_no_html) {
            const notAttendingCol = document.querySelector('h6#not-attending-count-header + div');
            if (notAttendingCol) notAttendingCol.innerHTML = data.rsvps_no_html;
        }
        if (data.waitlist_html) {
            // Find the Waitlist column by header text
            const waitlistHeader = Array.from(document.querySelectorAll('h6')).find(h => h.textContent.includes('Waitlist'));
            if (waitlistHeader) {
                const waitlistCol = waitlistHeader.nextElementSibling;
                if (waitlistCol) waitlistCol.innerHTML = data.waitlist_html;
            }
        }
        if (data.rsvp_count !== undefined) {
            const attendeesHeader = document.getElementById('attendee-count-header');
            if (attendeesHeader) attendeesHeader.innerHTML = `<i class="fas fa-check me-2"></i><span>Attendees (${data.rsvp_count})</span>`;
        }
        if (data.rsvp_no_count !== undefined) {
            const notAttendingHeader = document.getElementById('not-attending-count-header');
            if (notAttendingHeader) notAttendingHeader.innerHTML = `<i class="fas fa-times me-2"></i><span>Not Attending (${data.rsvp_no_count})</span>`;
        }
        if (data.rsvp_waitlist_count !== undefined) {
            const waitlistHeader = document.getElementById('waitlist-count-header');
            if (waitlistHeader) waitlistHeader.innerHTML = `<i class="fas fa-user-clock me-2"></i><span>Waitlist (${data.rsvp_waitlist_count})</span>`;
        } else if (data.waitlist_count !== undefined) {
            const waitlistHeader = document.getElementById('waitlist-count-header');
            if (waitlistHeader) waitlistHeader.innerHTML = `<i class="fas fa-user-clock me-2"></i><span>Waitlist (${data.waitlist_count})</span>`;
        } else if (data.rsvps_waitlist !== undefined) {
            const waitlistHeader = document.getElementById('waitlist-count-header');
            if (waitlistHeader) waitlistHeader.innerHTML = `<i class="fas fa-user-clock me-2"></i><span>Waitlist (${data.rsvps_waitlist.length || 0})</span>`;
        } else if (data.waitlist_html !== undefined) {
            // Count waitlist items from the HTML if no explicit count is provided
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = data.waitlist_html;
            const waitlistItems = tempDiv.querySelectorAll('.d-flex.align-items-center');
            const waitlistCount = waitlistItems.length;
            const waitlistHeader = document.getElementById('waitlist-count-header');
            if (waitlistHeader) waitlistHeader.innerHTML = `<i class="fas fa-user-clock me-2"></i><span>Waitlist (${waitlistCount})</span>`;
        } else {
            // If no waitlist data is provided, preserve the current count
            console.log('No waitlist data in response - preserving current count');
            const waitlistHeader = document.getElementById('waitlist-count-header');
            if (waitlistHeader) {
                // Extract current count from the header and maintain it
                const currentText = waitlistHeader.textContent;
                const currentCount = currentText.match(/Waitlist \((\d+)\)/);
                if (currentCount) {
                    waitlistHeader.innerHTML = `<i class="fas fa-user-clock me-2"></i><span>Waitlist (${currentCount[1]})</span>`;
                }
            }
        }
        // Update capacity pills if provided
        if (data.capacity_pills_html) {
            const pillsContainer = document.getElementById('capacity-pills');
            if (pillsContainer) pillsContainer.innerHTML = data.capacity_pills_html;
        }
        // Update header pills if provided
        if (data.header_pills_html) {
            const headerPills = document.getElementById('header-pills');
            if (headerPills) headerPills.innerHTML = data.header_pills_html;
        }
        
        // Update capacity section if there's attendance data
        if (data.rsvp_count !== undefined) {
            // Update capacity text
            const capacitySection = document.querySelector('.d-flex.justify-content-between .fw-bold');
            if (capacitySection && capacitySection.textContent === 'Capacity:') {
                const capacitySpan = capacitySection.parentElement.querySelector('span:last-child');
                if (capacitySpan) {
                    // Extract max_attendees from the existing text or use a data attribute if available
                    const maxAttendees = capacitySpan.textContent.match(/\/(\d+) attendees/);
                    if (maxAttendees) {
                        const maxAttendeesCount = parseInt(maxAttendees[1]);
                        // Update the text content
                        const pillsElement = capacitySpan.querySelector('#capacity-pills');
                        const pillsHtml = pillsElement ? pillsElement.outerHTML : '';
                        capacitySpan.innerHTML = `${data.rsvp_count}/${maxAttendeesCount} attendees <span id="capacity-pills">${data.capacity_pills_html || ''}</span>`;
                    }
                }
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.progress-bar');
            if (progressBar) {
                // Extract max_attendees from the capacity text or calculate from current percentage
                const capacityText = document.querySelector('.d-flex.justify-content-between span:last-child');
                if (capacityText) {
                    const maxAttendees = capacityText.textContent.match(/\/(\d+) attendees/);
                    if (maxAttendees) {
                        const maxAttendeesCount = parseInt(maxAttendees[1]);
                        const percentage = maxAttendeesCount > 0 ? (data.rsvp_count / maxAttendeesCount * 100) : 0;
                        progressBar.style.width = `${percentage}%`;
                    }
                }
            }
        }
    }
    
    function showMessage(message, type) {
        // Create a simple alert message
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert the message at the top of the attendance section
        const attendanceSection = document.getElementById('attendance-section');
        attendanceSection.insertBefore(alertDiv, attendanceSection.firstChild);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 3000);
    }
});

// Copy to clipboard function for share modal
function copyToClipboard(elementId) {
    const textarea = document.getElementById(elementId);
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show success feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
        
        // Reset button after 2 seconds
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-primary');
        }, 2000);
        
    } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(textarea.value).then(() => {
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 2000);
        }).catch(() => {
            alert('Could not copy to clipboard. Please select and copy manually.');
        });
    }
}

// Add to Calendar functionality
document.addEventListener('DOMContentLoaded', function() {
    // Store event data for calendar functions
    window.eventData = {
        title: {{ event.title|tojson }},
        startDate: {{ calendar_start|tojson }},
        endDate: {{ calendar_end|tojson }},
        location: {{ calendar_location|tojson }},
        description: {{ event.description|tojson }}
        {% if can_see_details and event.tips_for_attendees %}
        + "\n\nTips for attendees: " + {{ event.tips_for_attendees|tojson }}
        {% endif %}
        {% if not can_see_details %}
        + "\n\n" + {{ event.time_period|tojson }}
        {% endif %}
    };
});

function addToGoogleCalendar() {
    const event = window.eventData;
    const encodedTitle = encodeURIComponent(event.title);
    const encodedDescription = encodeURIComponent(event.description);
    const encodedLocation = encodeURIComponent(event.location);
    const url = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodedTitle}&dates=${event.startDate}/${event.endDate}&details=${encodedDescription}&location=${encodedLocation}`;
    window.open(url, '_blank');
}

function addToOutlookCalendar() {
    const event = window.eventData;
    const startISO = formatDateForOutlook(event.startDate);
    const endISO = formatDateForOutlook(event.endDate);
    const encodedTitle = encodeURIComponent(event.title);
    const encodedDescription = encodeURIComponent(event.description);
    const encodedLocation = encodeURIComponent(event.location);
    const url = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodedTitle}&startdt=${startISO}&enddt=${endISO}&body=${encodedDescription}&location=${encodedLocation}`;
    window.open(url, '_blank');
}

function addToYahooCalendar() {
    const event = window.eventData;
    const encodedTitle = encodeURIComponent(event.title);
    const encodedDescription = encodeURIComponent(event.description);
    const encodedLocation = encodeURIComponent(event.location);
    const url = `https://calendar.yahoo.com/?v=60&view=d&type=20&title=${encodedTitle}&st=${event.startDate}&dur=0200&desc=${encodedDescription}&in_loc=${encodedLocation}`;
    window.open(url, '_blank');
}

function addToAppleCalendar() {
    const event = window.eventData;
    const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//cosypolyamory.org//Event//EN
BEGIN:VEVENT
UID:event-{{ event.id }}-${Date.now()}@cosypolyamory.org
DTSTART:${event.startDate}
DTEND:${event.endDate}
SUMMARY:${event.title}
DESCRIPTION:${event.description.replace(/\n/g, '\\n')}
LOCATION:${event.location}
END:VEVENT
END:VCALENDAR`;
    
    const blob = new Blob([icsContent], { type: 'text/calendar' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${event.title}.ics`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function formatDateForOutlook(dateString) {
    return dateString.replace(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6');
}
</script>

<!-- Add to Calendar Modal -->
<div class="modal fade" id="addToCalendarModal" tabindex="-1" aria-labelledby="addToCalendarModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addToCalendarModalLabel">
                    <i class="fas fa-calendar-plus me-2"></i>Add to Calendar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Event Summary -->
                <div class="mb-4">
                    <h6 class="text-primary">{{ event.title }}</h6>
                    {% if can_see_details %}
                        <p class="mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>{{ event.exact_time.strftime('%A, %B %d, %Y at %I:%M %p') }}</strong>
                            {% if event.end_time %}
                                - {{ event.end_time.strftime('%I:%M %p') }}
                            {% endif %}
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ event.establishment_name }}
                        </p>
                    {% else %}
                        <p class="mb-2">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>{{ event.time_period }}</strong>
                        </p>
                        <p class="mb-2">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ event.barrio }}
                        </p>
                        <div class="alert alert-info">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Exact time and location details are available to approved community members.
                            </small>
                        </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <h6 class="mb-2">Description:</h6>
                        <div class="text-muted">
                            {% set description_lines = event.description.split('\n') %}
                            {% set excerpt_lines = description_lines[:3] %}
                            {% for line in excerpt_lines %}
                                {% if line.strip() %}
                                    <p class="mb-2">{{ line.strip() }}</p>
                                {% endif %}
                            {% endfor %}
                            {% if description_lines|length > 3 %}
                                <p class="mb-0"><em>...</em></p>
                            {% endif %}
                        </div>
                        {% if can_see_details and event.tips_for_attendees %}
                            <h6 class="mb-2 mt-3">Tips for attendees:</h6>
                            <div class="text-muted">
                                {% set tips_lines = event.tips_for_attendees.split('\n') %}
                                {% set tips_excerpt = tips_lines[:2] %}
                                {% for line in tips_excerpt %}
                                    {% if line.strip() %}
                                        <p class="mb-2">{{ line.strip() }}</p>
                                    {% endif %}
                                {% endfor %}
                                {% if tips_lines|length > 2 %}
                                    <p class="mb-0"><em>... (excerpt)</em></p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Calendar Options -->
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-primary" onclick="addToGoogleCalendar()">
                        <i class="fab fa-google me-2"></i>Google Calendar
                    </button>
                    <button type="button" class="btn btn-info" onclick="addToOutlookCalendar()">
                        <i class="fab fa-microsoft me-2"></i>Outlook Calendar
                    </button>
                    <button type="button" class="btn btn-warning" onclick="addToYahooCalendar()">
                        <i class="fab fa-yahoo me-2"></i>Yahoo Calendar
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="addToAppleCalendar()">
                        <i class="fab fa-apple me-2"></i>Apple Calendar (Download .ics)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
