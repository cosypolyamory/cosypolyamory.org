{% extends "layout/base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Your Profile</h1>
        {% if user.role not in ("new", "pending") %}
            <a href="{{ url_for('auth.my_events') }}" class="btn btn-primary">
                <i class="fas fa-calendar-check me-1"></i>My Events
            </a>
        {% endif %}
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Profile Update Form for users with incomplete data -->
    {% if needs_info %}
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Complete Your Profile
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    Please complete the required information below to finish setting up your profile.
                </p>
                <p class="mb-3">
                    Please enter the email
                    address where you would like to receive notifcations about events that you've joined. Also, please give us
                    the name that you would like to use on the site; ideally the name you give us here is the name you'd like
                    other members to call you during our events. Finally, please enter your pronouns so that other community
                    members can address you appropriately.
                </p>
                <form method="POST" action="{{ url_for('auth.update_profile') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address <span class="text-danger">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{% if form_data and form_data.email %}{{ form_data.email }}{% elif not user.email.endswith('@reddit.local') and not user.email.endswith('@musicbrainz.local') %}{{ user.email }}{% endif %}" 
                                       required placeholder="your-email@example.com">
                                <div class="form-text">This will be used for community communications</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Display Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{% if form_data and form_data.name %}{{ form_data.name }}{% elif not user.name.startswith('mb_user_') and not user.name.startswith('musicbrainz_user_') %}{{ user.name }}{% endif %}" 
                                       required placeholder="Your preferred name">
                                <div class="form-text">How you'd like to be known in the community</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pronoun_singular" class="form-label">
                            <i class="fas fa-user-tag me-1"></i>Preferred Pronouns<span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="pronoun_singular" name="pronoun_singular" 
                               value="{% if form_data and form_data.pronoun_singular %}{{ form_data.pronoun_singular }}{% else %}{{ user.pronouns or '' }}{% endif %}" 
                               required placeholder="they/them/theirs">
                        <div id="pronounValidationFeedback" class="mt-2" style="display: none;"></div>
                        <div class="form-text">e.g., they/them/theirs, she/her, he/him — words separated by slashes</div>
                    </div>
                    <button type="submit" class="btn btn-warning" id="completeProfileBtn">
                        <i class="fas fa-save me-2"></i>Complete Profile
                    </button>
                </form>
            </div>
        </div>
    {% endif %}
        
    <!-- Join Community Call-to-Action for new users -->
    {% if not needs_info and (not user.role or user.role == "new") %}
    
        <p class="mb-3">
            To access full event details and to attend our events, you'll need to complete a brief
            application. This helps us maintain a safe and welcoming space for everyone.
        </p>
        <div class="text-center" style="margin: 0 0 3em 0">
            <div class="d-grid gap-2 d-md-block">
                <a href="{{ url_for('user.apply') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>
                    Apply Now
                </a>
            </div>
        </div>

    {% elif user.role == 'pending' %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-users me-2 text-primary"></i>
                    Community Access
                </h5>
                
                <div class="alert alert-warning">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Application Under Review</strong> - Your community application is being reviewed.
                </div>
            </div>
        </div>
    {% endif %}
        
    <!-- Edit Profile Section for all users -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Profile Information</h5>
            <div class="d-flex gap-2">
                {% if not (current_user.is_admin or current_user.role == 'admin') %}
                    <a href="{{ url_for('user.delete_account') }}" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash me-1"></i>Delete Account
                    </a>
                {% endif %}
                {% if not needs_info %}
                    <button class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-9">
                    
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Account type:</strong></td>
                            <td>
                                {% if user.role == 'admin' %}
                                        administrator
                                {% elif user.role == 'organizer' %}
                                        organizer
                                {% elif user.role == 'approved' %}
                                        member
                                {% elif user.role == 'pending' %}
                                        application Pending
                                {% else %}
                                        new user
                                {% endif %}
                            </td>
                        </tr>
                        {% if user.pronouns %}
                        <tr>
                            <td><strong>Pronouns:</strong></td>
                            <td>{{ user.pronouns }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><strong>User Email:</strong></td>
                            <td>{{ user.email }}</td>
                        </tr>
                        <tr>
                            <td><strong>Logged in with:</strong></td>
                            <td>
                                {% if user.provider == 'google' %}
                                    Google
                                {% elif user.provider == 'github' %}
                                    GitHub
                                {% elif user.provider == 'reddit' %}
                                    Reddit
                                {% elif user.provider == 'musicbrainz' %}
                                    MusicBrainz
                                {% else %}
                                    {{ user.provider|title }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Member since:</strong></td>
                            <td>{{ user.created_at.strftime('%B %d, %Y at %H:%M') }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProfileForm" method="POST" action="{{ url_for('auth.update_profile') }}">
                <input type="hidden" name="ajax" value="1">
                <div class="modal-body">
                    <!-- Error alert div (initially hidden) -->
                    <div id="editProfileError" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="editProfileErrorText"></span>
                    </div>
                    
                    <!-- Success alert div (initially hidden) -->
                    <div id="editProfileSuccess" class="alert alert-success d-none" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="editProfileSuccessText"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">
                            <i class="fas fa-envelope me-1"></i>Email Address <span class="text-danger">*</span>
                        </label>
                        <input type="email" class="form-control" id="editEmail" name="email" 
                               value="{% if form_data and form_data.email %}{{ form_data.email }}{% else %}{{ user.email }}{% endif %}" required>
                        <div class="form-text">Used for community communications</div>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">
                            <i class="fas fa-user me-1"></i>Display Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="editName" name="name" 
                               value="{% if form_data and form_data.name %}{{ form_data.name }}{% else %}{{ user.name }}{% endif %}" required>
                        <div class="form-text">How you'd like to be known in the community</div>
                    </div>
                    <div class="mb-3">
                        <label for="editPronounSingular" class="form-label">
                            <i class="fas fa-user-tag me-1"></i>Pronouns <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="editPronounSingular" name="pronoun_singular" 
                               value="{% if form_data and form_data.pronoun_singular %}{{ form_data.pronoun_singular }}{% else %}{{ user.pronouns or '' }}{% endif %}" 
                               placeholder="they/them/theirs" required>
                        <div id="editPronounValidationFeedback" class="mt-2" style="display: none;"></div>
                        <div class="form-text">e.g., they/them/theirs, she/her, he/him — words separated by slashes</div>
                    </div>
                    {% if user.provider in ['reddit', 'musicbrainz'] %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> {{ user.provider|title }} doesn't provide email addresses, so we rely on the information you provide here.
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveProfileBtn" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    /**
     * Centralized pronoun validation function
     * Accepts: alphabetic characters, spaces, and slashes only
     * Format: word/word/word... (2+ words separated by slashes)
     * @param {string} input - Raw pronoun input
     * @returns {Object} - { valid: boolean, normalized: string, error: string }
     */
    function validateAndNormalizePronouns(input) {
        if (!input || !input.trim()) {
            return { valid: false, normalized: '', error: 'Pronouns are required.' };
        }
        
        const trimmed = input.trim();
        
        // Only allow alphabetic characters, spaces, and slashes
        if (!/^[a-zA-Z\s\/]+$/.test(trimmed)) {
            return { 
                valid: false, 
                normalized: '', 
                error: 'Pronouns can only contain letters, spaces, and slashes.' 
            };
        }
        
        // Check for leading or trailing slashes
        if (trimmed.startsWith('/') || trimmed.endsWith('/')) {
            return { 
                valid: false, 
                normalized: '', 
                error: 'Pronouns cannot start or end with a slash.' 
            };
        }
        
        // Normalize: remove all spaces and split by slashes
        const normalized = trimmed.replace(/\s+/g, '');
        const parts = normalized.split('/').filter(p => p.length > 0);
        
        // Must have 2-5 parts
        if (parts.length < 2) {
            return { 
                valid: false, 
                normalized: '', 
                error: 'Pronouns must have at least 2 words separated by slashes (e.g., they/them).' 
            };
        }
        
        if (parts.length > 5) {
            return { 
                valid: false, 
                normalized: '', 
                error: 'Pronouns cannot have more than 5 words.' 
            };
        }
        
        // Each part must be 1-15 characters
        for (const part of parts) {
            if (part.length < 1 || part.length > 15) {
                return { 
                    valid: false, 
                    normalized: '', 
                    error: 'Each pronoun word must be 1-15 letters.' 
                };
            }
        }
        
        return { valid: true, normalized: normalized, error: null };
    }
    
    /**
     * Setup debounced validation for a pronoun input field
     * @param {HTMLInputElement} input - The input element
     * @param {HTMLElement} feedback - The feedback div
     * @param {HTMLButtonElement} submitBtn - The submit button to enable/disable
     * @param {Function} additionalCheck - Optional callback to check other form fields
     * @param {number} delay - Debounce delay in ms (default 500)
     */
    function setupPronounValidation(input, feedback, submitBtn, additionalCheck = null, delay = 500) {
        let timeoutId = null;
        
        const validateInput = () => {
            const result = validateAndNormalizePronouns(input.value);
            
            if (input.value.trim() === '') {
                // Empty - disable button, hide feedback
                if (submitBtn && !additionalCheck) submitBtn.disabled = true;
                feedback.style.display = 'none';
                input.classList.remove('is-invalid', 'is-valid');
            } else if (!result.valid) {
                // Invalid - disable button, show error
                if (submitBtn && !additionalCheck) submitBtn.disabled = true;
                feedback.style.display = 'block';
                feedback.className = 'alert alert-danger mt-2';
                feedback.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + result.error;
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
            } else {
                // Valid - enable button, show success
                if (submitBtn && !additionalCheck) submitBtn.disabled = false;
                feedback.style.display = 'block';
                feedback.className = 'alert alert-success mt-2';
                feedback.innerHTML = '<i class="fas fa-check-circle me-2"></i>Valid! Will be saved as: <strong>' + result.normalized + '</strong>';
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
            }
            
            // Call additional check if provided (for forms with multiple fields)
            if (additionalCheck) {
                additionalCheck();
            }
        };
        
        input.addEventListener('input', function() {
            // Clear previous timeout
            if (timeoutId) clearTimeout(timeoutId);
            
            // Set new timeout for debounced validation
            timeoutId = setTimeout(validateInput, delay);
        });
        
        // Validate immediately on page load if there's a value
        if (input.value.trim()) {
            validateInput();
        } else if (submitBtn && !additionalCheck) {
            submitBtn.disabled = true;
        }
    }
    
    // Setup validation for complete profile form
    const completeProfileBtn = document.getElementById('completeProfileBtn');
    const pronounInput = document.getElementById('pronoun_singular');
    const pronounFeedback = document.getElementById('pronounValidationFeedback');
    
    if (pronounInput && pronounFeedback) {
        setupPronounValidation(pronounInput, pronounFeedback, completeProfileBtn);
    }
    
    // Setup validation for edit profile modal
    const saveBtn = document.getElementById('saveProfileBtn');
    const editPronounInput = document.getElementById('editPronounSingular');
    const editPronounFeedback = document.getElementById('editPronounValidationFeedback');
    const editEmailInput = document.getElementById('editEmail');
    const editNameInput = document.getElementById('editName');
    
    // Function to check if all edit form fields are valid
    function checkEditFormValidity() {
        if (!saveBtn) return;
        
        const email = editEmailInput ? editEmailInput.value.trim() : '';
        const name = editNameInput ? editNameInput.value.trim() : '';
        const pronouns = editPronounInput ? editPronounInput.value.trim() : '';
        
        // Check basic requirements
        const hasEmail = email.length > 0 && email.includes('@') && email.includes('.');
        const hasName = name.length > 0;
        const pronounResult = validateAndNormalizePronouns(pronouns);
        
        // Enable button only if all fields are valid
        saveBtn.disabled = !(hasEmail && hasName && pronounResult.valid);
    }
    
    // Setup pronoun validation with additional form check
    if (editPronounInput && editPronounFeedback && saveBtn) {
        setupPronounValidation(editPronounInput, editPronounFeedback, saveBtn, checkEditFormValidity);
    }
    
    // Add listeners to other fields
    if (editEmailInput) {
        editEmailInput.addEventListener('input', checkEditFormValidity);
    }
    if (editNameInput) {
        editNameInput.addEventListener('input', checkEditFormValidity);
    }
    
    // Check validity on page load
    if (saveBtn) {
        checkEditFormValidity();
    }
    
    // Reset modal to fresh values when opened
    const editProfileModal = document.getElementById('editProfileModal');
    if (editProfileModal) {
        editProfileModal.addEventListener('show.bs.modal', function() {
            // Reset form fields to original user values
            if (editEmailInput) {
                editEmailInput.value = '{{ user.email }}';
                editEmailInput.classList.remove('is-invalid', 'is-valid');
            }
            if (editNameInput) {
                editNameInput.value = '{{ user.name }}';
                editNameInput.classList.remove('is-invalid', 'is-valid');
            }
            if (editPronounInput) {
                editPronounInput.value = '{{ user.pronouns or "" }}';
                editPronounInput.classList.remove('is-invalid', 'is-valid');
            }
            
            // Hide validation feedback
            if (editPronounFeedback) {
                editPronounFeedback.style.display = 'none';
            }
            
            // Hide any error/success messages
            if (errorDiv) errorDiv.classList.add('d-none');
            if (successDiv) successDiv.classList.add('d-none');
            
            // Reset button text
            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Changes';
            }
            
            // Re-check form validity with fresh values
            checkEditFormValidity();
        });
    }
    
    // Handle edit profile form submission
    const form = document.getElementById('editProfileForm');
    const errorDiv = document.getElementById('editProfileError');
    const errorText = document.getElementById('editProfileErrorText');
    const successDiv = document.getElementById('editProfileSuccess');
    const successText = document.getElementById('editProfileSuccessText');
    
    function showError(message) {
        errorText.textContent = message;
        errorDiv.classList.remove('d-none');
        successDiv.classList.add('d-none');
    }
    
    function showSuccess(message) {
        successText.textContent = message;
        successDiv.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        
        // Close modal after 1.5 seconds and reload page to show updated info
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
            location.reload();
        }, 1500);
    }
    
    function hideAlerts() {
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
    }
    
    if (saveBtn && form) {
        saveBtn.addEventListener('click', function() {
            hideAlerts();
            
            // Get form data
            const formData = new FormData(form);
            const email = formData.get('email').trim();
            const name = formData.get('name').trim();
            const pronounsInput = formData.get('pronoun_singular');
            
            // Basic validation
            if (!email || !name) {
                showError('Both email and name are required.');
                return;
            }
            
            // Validate and normalize pronouns
            const pronounResult = validateAndNormalizePronouns(pronounsInput);
            if (!pronounResult.valid) {
                showError(pronounResult.error);
                return;
            }
            
            // Set normalized pronouns (spaces removed)
            formData.set('pronoun_singular', pronounResult.normalized);
            
            if (!email.includes('@') || !email.includes('.')) {
                showError('Please enter a valid email address.');
                return;
            }
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            // Submit via AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message || 'Profile updated successfully!');
                } else {
                    showError(data.error || 'An error occurred while updating your profile.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('An error occurred while updating your profile.');
            })
            .finally(() => {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Changes';
            });
        });
    }
    
    // Show the edit modal automatically when there are form errors
    {% if show_edit_modal %}
    var editModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
    editModal.show();
    {% endif %}
});
</script>

{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
