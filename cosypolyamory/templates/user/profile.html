{% extends "layout/base.html" %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="container">
    <h1>Your Profile</h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'info' if category == 'info' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if user.role in ("approved", "organizer", "admin") %}
        <!-- User's RSVP Events Section (for approved users only) -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-check me-2"></i>Your upcoming event confirmations
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Date & Time</th>
                                <th>RSVP Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rsvp in user_rsvps %}
                            <tr>
                                <td>
                                    <strong>
                                        <a href="{{ url_for('events.event_detail', event_id=rsvp.event.id) }}" >
                                            {{ rsvp.event.title }}
                                        </a>
                                    </strong>
                                </td>
                                <td>
                                    <div>{{ rsvp.event.exact_time.strftime('%a, %b %d, %Y') }}</div>
                                    <small class="text-muted">{{ rsvp.event.exact_time.strftime('%H:%M') }}</small>
                                </td>
                                <td>
                                    {% if rsvp.status == 'yes' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Attending
                                        </span>
                                    {% elif rsvp.status == 'no' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times me-1"></i>Not Attending
                                        </span>
                                    {% elif rsvp.status == 'maybe' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-question me-1"></i>Maybe
                                        </span>
                                    {% elif rsvp.status == 'waitlist' %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-clock me-1"></i>Waitlisted
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">You don't have any upcoming event confirmations.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if user_rsvps|length == 10 %}
                    <div class="text-center mt-3">
                        <small class="text-muted">Showing your 10 most recent RSVPs</small>
                    </div>
                {% endif %}
            </div>
        </div>
    {% endif %}


        <!-- Profile Update Form for users with incomplete data -->
    {% if needs_info %}
        <div class="card mt-4 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Complete Your Profile
                </h5>
            </div>
            <div class="card-body">
                <p class="mb-3">
                    Please complete the required information below to finish setting up your profile.
                </p>
                <p class="mb-3">
                    Please enter the email
                    address where you would like to receive notifcations about events that you've joined. Also, please give us
                    the name that you would like to use on the site; ideally the name you give us here is the name you'd like
                    other members to call you during our events. Finally, please enter your pronouns so that other community
                    members can address you appropriately.
                </p>
                <form method="POST" action="{{ url_for('auth.update_profile') }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>Email Address <span class="text-danger">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{% if form_data and form_data.email %}{{ form_data.email }}{% elif not user.email.endswith('@reddit.local') and not user.email.endswith('@musicbrainz.local') %}{{ user.email }}{% endif %}" 
                                       required placeholder="your-email@example.com">
                                <div class="form-text">This will be used for community communications</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-user me-1"></i>Display Name <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{% if form_data and form_data.name %}{{ form_data.name }}{% elif not user.name.startswith('mb_user_') and not user.name.startswith('musicbrainz_user_') %}{{ user.name }}{% endif %}" 
                                       required placeholder="Your preferred name">
                                <div class="form-text">How you'd like to be known in the community</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="pronoun_singular" class="form-label">
                            <i class="fas fa-user-tag me-1"></i>Preferred Pronouns<span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="pronoun_singular" name="pronoun_singular" 
                               value="{% if form_data and form_data.pronoun_singular %}{{ form_data.pronoun_singular }}{% else %}{{ user.pronouns or '' }}{% endif %}" 
                               required placeholder="they/them, she/her, he/him"
                               pattern="^[a-zA-Z0-9]{2,15}/[a-zA-Z0-9]{2,15}$"
                               title="Pronouns must be in format: 2-15 alphanumeric characters, slash, 2-15 alphanumeric characters (e.g., they/them)">
                        <div class="form-text">e.g., they/them, she/her, he/him (format: word/word)</div>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Complete Profile
                    </button>
                </form>
            </div>
        </div>
    {% endif %}
        
    <!-- Join Community Call-to-Action for new users -->
    {% if not user.role or user.role == "new" %}
    
        <p class="mb-3">
            To access full event details and to attend our events, you'll need to complete a brief
            application. This helps us maintain a safe and welcoming space for everyone.
        </p>
        <div class="text-center" style="margin: 0 0 3em 0">
            <div class="d-grid gap-2 d-md-block">
                <a href="{{ url_for('user.apply') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>
                    Apply Now
                </a>
            </div>
        </div>

    {% elif user.role == 'pending' %}
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-users me-2 text-primary"></i>
                    Community Access
                </h5>
                
                <div class="alert alert-warning">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Application Under Review</strong> - Your community application is being reviewed.
                </div>
            </div>
        </div>
    {% endif %}
        
    <!-- Edit Profile Section for all users -->
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Profile Information</h5>
            {% if not needs_info %}
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                    <i class="fas fa-edit me-1"></i>Edit Profile
                </button>
            {% endif %}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-9">
                    
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Account type:</strong></td>
                            <td>
                                {% if user.role == 'admin' %}
                                        administrator
                                {% elif user.role == 'organizer' %}
                                        organizer
                                {% elif user.role == 'approved' %}
                                        member
                                {% elif user.role == 'pending' %}
                                        application Pending
                                {% else %}
                                        new user
                                {% endif %}
                            </td>
                        </tr>
                        {% if user.pronouns %}
                        <tr>
                            <td><strong>Pronouns:</strong></td>
                            <td>{{ user.pronouns }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td><strong>User Email:</strong></td>
                            <td>{{ user.email }}</td>
                        </tr>
                        <tr>
                            <td><strong>Logged in with:</strong></td>
                            <td>
                                {% if user.provider == 'google' %}
                                    Google
                                {% elif user.provider == 'github' %}
                                    GitHub
                                {% elif user.provider == 'reddit' %}
                                    Reddit
                                {% elif user.provider == 'musicbrainz' %}
                                    MusicBrainz
                                {% else %}
                                    {{ user.provider|title }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Member since:</strong></td>
                            <td>{{ user.created_at.strftime('%B %d, %Y at %H:%M') }}</td>
                        </tr>
                    </table>
                    
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProfileForm" method="POST" action="{{ url_for('auth.update_profile') }}">
                <input type="hidden" name="ajax" value="1">
                <div class="modal-body">
                    <!-- Error alert div (initially hidden) -->
                    <div id="editProfileError" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="editProfileErrorText"></span>
                    </div>
                    
                    <!-- Success alert div (initially hidden) -->
                    <div id="editProfileSuccess" class="alert alert-success d-none" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="editProfileSuccessText"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">
                            <i class="fas fa-envelope me-1"></i>Email Address <span class="text-danger">*</span>
                        </label>
                        <input type="email" class="form-control" id="editEmail" name="email" 
                               value="{% if form_data and form_data.email %}{{ form_data.email }}{% else %}{{ user.email }}{% endif %}" required>
                        <div class="form-text">Used for community communications</div>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">
                            <i class="fas fa-user me-1"></i>Display Name <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="editName" name="name" 
                               value="{% if form_data and form_data.name %}{{ form_data.name }}{% else %}{{ user.name }}{% endif %}" required>
                        <div class="form-text">How you'd like to be known in the community</div>
                    </div>
                    <div class="mb-3">
                        <label for="editPronounSingular" class="form-label">
                            <i class="fas fa-user-tag me-1"></i>Pronouns <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="editPronounSingular" name="pronoun_singular" 
                               value="{% if form_data and form_data.pronoun_singular %}{{ form_data.pronoun_singular }}{% else %}{{ user.pronouns or '' }}{% endif %}" 
                               placeholder="they/them, she/her, he/him" required
                               pattern="^[a-zA-Z0-9]{2,15}/[a-zA-Z0-9]{2,15}$"
                               title="Pronouns must be in format: 2-15 alphanumeric characters, slash, 2-15 alphanumeric characters (e.g., they/them)">
                        <div class="form-text">e.g., they/them, she/her, he/him (format: word/word)</div>
                    </div>
                    {% if user.provider in ['reddit', 'musicbrainz'] %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> {{ user.provider|title }} doesn't provide email addresses, so we rely on the information you provide here.
                        </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveProfileBtn" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle edit profile form submission
    const saveBtn = document.getElementById('saveProfileBtn');
    const form = document.getElementById('editProfileForm');
    const errorDiv = document.getElementById('editProfileError');
    const errorText = document.getElementById('editProfileErrorText');
    const successDiv = document.getElementById('editProfileSuccess');
    const successText = document.getElementById('editProfileSuccessText');
    
    function showError(message) {
        errorText.textContent = message;
        errorDiv.classList.remove('d-none');
        successDiv.classList.add('d-none');
    }
    
    function showSuccess(message) {
        successText.textContent = message;
        successDiv.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        
        // Close modal after 1.5 seconds and reload page to show updated info
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
            location.reload();
        }, 1500);
    }
    
    function hideAlerts() {
        errorDiv.classList.add('d-none');
        successDiv.classList.add('d-none');
    }
    
    if (saveBtn && form) {
        saveBtn.addEventListener('click', function() {
            hideAlerts();
            
            // Get form data
            const formData = new FormData(form);
            const email = formData.get('email').trim();
            const name = formData.get('name').trim();
            const pronouns = formData.get('pronoun_singular').trim(); // Keep old field name for compatibility
            
            // Basic validation
            if (!email || !name) {
                showError('Both email and name are required.');
                return;
            }
            
            if (!pronouns) {
                showError('Pronouns are required.');
                return;
            }
            
            // Validate pronouns format: 2-15 alphanumeric characters, slash, 2-15 alphanumeric characters
            const pronounRegex = /^[a-zA-Z0-9]{2,15}\/[a-zA-Z0-9]{2,15}$/;
            if (!pronounRegex.test(pronouns)) {
                showError('Pronouns must be in format: word/word (e.g., they/them, she/her, he/him). Each part should be 2-15 alphanumeric characters.');
                return;
            }
            
            if (!email.includes('@') || !email.includes('.')) {
                showError('Please enter a valid email address.');
                return;
            }
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            
            // Submit via AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message || 'Profile updated successfully!');
                } else {
                    showError(data.error || 'An error occurred while updating your profile.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('An error occurred while updating your profile.');
            })
            .finally(() => {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Changes';
            });
        });
    }
    
    // Show the edit modal automatically when there are form errors
    {% if show_edit_modal %}
    var editModal = new bootstrap.Modal(document.getElementById('editProfileModal'));
    editModal.show();
    {% endif %}
});
</script>

{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}
